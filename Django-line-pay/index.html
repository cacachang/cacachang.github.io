<!DOCTYPE html><html lang="zh-TW"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><meta name="author"><title>Django - LINE Pay 串接實戰 · NingLab</title><meta name="description" content="LINE Pay 已經是現在大眾很習慣的付款方式
不過目前用 Django 串接 LINE Pay 的資源很少
所以今天想跟大家分享如何在 Django 中串接 LINE Pay
分成以下四個步驟

申請 SandBox 帳號密碼
申請 Channel ID &amp;amp; Key
串接 Request"><meta name="keywords"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><script async src="https://www.googletagmanager.com/gtag/js?id=G-4P2R013PGL"></script><script>window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'G-4P2R013PGL')
</script><meta name="renderer" content="webkit"><link rel="short icon" href="/images/favicon.jpeg" type="image/x-icon"><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="/css/blog_basic.css"><link rel="stylesheet" href="/css/font-awesome.min.css"><link rel="alternate" type="application/atom+xml" title="ATOM 1.0" href="/atom.xml"><meta name="generator" content="Hexo 7.1.1"></head><body><div class="sidebar animated fadeInDown"><div class="logo-title"><div class="title"><img src="/images/ning.jpg" style="width:200px;"><h3 title=""><a href="/">NingLab</a></h3></div></div><ul class="social-links"><li><a target="_blank" rel="noopener" href="https://twitter.com/ningchang_"><i class="fa fa-twitter"></i></a></li><li><a target="_blank" rel="noopener" href="https://github.com/cacachang"><i class="fa fa-github"></i></a></li><li><a href="mailto:a24701770@gmail.com"><i class="fa fa-envelope"></i></a></li><li><a target="_blank" rel="noopener" href="https://www.instagram.com/web543_/"><i class="fa fa-instagram"></i></a></li><li><a target="_blank" rel="noopener" href="https://www.linkedin.com/in/cacachang/"><i class="fa fa-linkedin"></i></a></li><li><a target="_blank" rel="noopener" href="https://www.youtube.com/channel/UCwRiNPzYITZWaif23HTmHZQ"><i class="fa fa-youtube"></i></a></li></ul><div class="footer"><div class="by_farbox"><a href="https://hexo.io/zh-cn/" target="_blank">Proudly published with Hexo&#65281;</a></div></div></div><div class="main"><div class="page-top animated fadeInDown"><div class="nav"><li><a href="/">首頁</a></li><li><a href="/archives">文章</a></li><li><a href="/categories">目錄</a></li><li><a href="/about">關於 Ning</a></li></div><div class="information"><div class="back_btn"><li><a class="fa fa-chevron-left" onclick="window.history.go(-1)"> </a></li></div><div class="avatar"><img src="/images/favicon.jpeg"></div></div></div><div class="autopagerize_page_element"><div class="content"><div class="post-page"><div class="post animated fadeInDown"><div class="post-title"><h3><a>Django - LINE Pay 串接實戰</a></h3></div><div class="post-content"><p>LINE Pay 已經是現在大眾很習慣的付款方式</p>
<p>不過目前用 Django 串接 LINE Pay 的資源很少</p>
<p>所以今天想跟大家分享如何在 Django 中串接 LINE Pay</p>
<p>分成以下四個步驟</p>
<ol>
<li>申請 SandBox 帳號密碼</li>
<li>申請 Channel ID &amp; Key</li>
<li>串接 Request</li>
<li>串接 Confirm</li>
</ol>
<p>因為目前還沒有正式的商店，所以就先用 Sandbox </p>
<ul>
<li>使用 LinePay v3</li>
</ul>
<h3 id="GitHub-參考"><a href="#GitHub-參考" class="headerlink" title="GitHub 參考"></a>GitHub 參考</h3><p><a target="_blank" rel="noopener" href="https://github.com/cacachang/django_line_pay">https://github.com/cacachang/django_line_pay</a></p>
<h2 id="Step-1-LINE-Pay-相關申請"><a href="#Step-1-LINE-Pay-相關申請" class="headerlink" title="Step 1. LINE Pay 相關申請"></a>Step 1. LINE Pay 相關申請</h2><p>至 <a target="_blank" rel="noopener" href="https://pay.line.me/tw/developers/techsupport/sandbox/creation?locale=zh_TW">LINE Pay Developers</a> 申請建立 Sandbox<br>填寫完畢後，至 Mail 收信拿 Sandbox 帳號密碼</p>
<p><img src="https://imgur.com/3G965Ag.jpg" alt="LINE Pay Sandbox"></p>
<p>登入 <a target="_blank" rel="noopener" href="https://pay.line.me/portal/tw/auth/login">LINE Pay 後台</a></p>
<p><img src="https://imgur.com/FaMU0kZ.jpg" alt="LINE Pay"></p>
<p>登入成功後，進入後台申請 Channel ID &amp; Channel Secret Key</p>
<p>收到 Mail，填入驗證碼後就可以拿到 Channel ID &amp; Channel Secret Key</p>
<p><img src="https://imgur.com/HpA6RUG.jpg" alt="LINE Pay"></p>
<p>將 Channel ID &amp; Channel Secret Key 放到環境變數中</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"># .env</span><br><span class="line"></span><br><span class="line">LINE_CHANNEL_ID=xxxxxxxx</span><br><span class="line">LINE_CHANNEL_SECRET_KEY=xxxxxxxx</span><br></pre></td></tr></table></figure>

<h2 id="Step-2-向-LINE-Pay-請求付款資訊"><a href="#Step-2-向-LINE-Pay-請求付款資訊" class="headerlink" title="Step 2. 向 LINE Pay 請求付款資訊"></a>Step 2. 向 LINE Pay 請求付款資訊</h2><p>我們要使用 LINE Pay 來做付款，</p>
<p>請求付款是要打 Request API </p>
<p>所以我們必須要發送 request 到該 API</p>
<h4 id="設定-urls-與-views"><a href="#設定-urls-與-views" class="headerlink" title="設定 urls 與 views"></a>設定 urls 與 views</h4><p>金流的資料相對比較機密，我會採用後端的方式去打 API </p>
<p>所以我們就需要設定一個 urls 與 views </p>
<p>當使用者按下結帳按鈕時，就會至該網址，並且於 views 發送 request 給 LINE Pay</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"># payment/urls.py</span><br><span class="line"></span><br><span class="line">from django.contrib import admin</span><br><span class="line">from django.urls import path</span><br><span class="line">from . import views</span><br><span class="line"></span><br><span class="line">app_name = &quot;payment&quot;</span><br><span class="line"></span><br><span class="line">urlpatterns = [</span><br><span class="line">    path(&#x27;request&#x27;, views.request, name=&#x27;request&#x27;),</span><br><span class="line">]</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>記得也要加入 templates</p>
<h4 id="組裝-request-需要的-headers-body"><a href="#組裝-request-需要的-headers-body" class="headerlink" title="組裝 request 需要的 headers &amp; body"></a>組裝 request 需要的 headers &amp; body</h4><p>官方手冊 Request API 的規格</p>
<p>方法 <code>POST</code><br>URL <code>/v3/payments/request</code></p>
<p>headers 會需要 body 的資料，所以我們就先來建立 body</p>
<h4 id="建立-body"><a href="#建立-body" class="headerlink" title="建立 body"></a>建立 body</h4><p>這邊我們先建立必填的 items</p>
<p><img src="https://imgur.com/CNHLU4F.jpg" alt="LINE Pay body"></p>
<p>items 之多，圖片不及備載，如果有額外需求，可以至<a target="_blank" rel="noopener" href="https://pay.line.me/tw/developers/apis/onlineApis?locale=zh_TW">官方手冊</a>翻相關的 items 並加入</p>
<p>接下來我們就先來做 body 吧</p>
<p>基本的總額 &#x2F; 幣別，是串金流非常基本的參數，這邊就不多做介紹</p>
<p><code>orderId</code> 需放訂單的 <code>id</code>，到時候 API 打回來的 response 會有 orderId 讓我們去找到該 order </p>
<ul>
<li>文章用所以先用 uuid 來代替，在專案上請使用訂單的 id 來取代</li>
</ul>
<p><code>packages</code> 把他當成商品組合，要塞該商品的 id 以及總額，如果不是組合的話，<code>package_id</code> 可以用 uuid 帶過即可，<code>products</code> 則是組合中的商品們</p>
<p><code>redirectUrls</code> 在我們發送 request 出去後，取消付款以及付款確認後要轉回來的網址</p>
<ul>
<li>HOSTNAME 環境變數可以使用 NGROK 或網域</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"># payment/views.py</span><br><span class="line"></span><br><span class="line">from django.shortcuts import render</span><br><span class="line">from django.utils import timezone</span><br><span class="line">from pathlib import Path</span><br><span class="line">from django.shortcuts import redirect</span><br><span class="line">import os</span><br><span class="line">import uuid</span><br><span class="line">import environ</span><br><span class="line"></span><br><span class="line">BASE_DIR = Path(__file__).resolve().parent.parent</span><br><span class="line">env = environ.Env()</span><br><span class="line">environ.Env.read_env(os.path.join(BASE_DIR, &#x27;.env&#x27;))</span><br><span class="line"></span><br><span class="line">def request(request):</span><br><span class="line">    if request.method == &quot;POST&quot;:</span><br><span class="line">        order_id = f&quot;order_&#123;str(uuid.uuid4())&#125;&quot;</span><br><span class="line">        package_id = f&quot;package_&#123;str(uuid.uuid4())&#125;&quot;</span><br><span class="line"></span><br><span class="line">        payload = &#123;</span><br><span class="line">            &#x27;amount&#x27;: 100,</span><br><span class="line">            &#x27;currency&#x27;: &#x27;TWD&#x27;,</span><br><span class="line">            &#x27;orderId&#x27;: order_id,</span><br><span class="line">            &#x27;packages&#x27;: [&#123;</span><br><span class="line">                &#x27;id&#x27;: package_id,</span><br><span class="line">                &#x27;amount&#x27;: 100,</span><br><span class="line">                &#x27;products&#x27;: [&#123;</span><br><span class="line">                    &#x27;id&#x27;: &#x27;1&#x27;,</span><br><span class="line">                    &#x27;name&#x27;: &#x27;測試商品&#x27;,</span><br><span class="line">                    &#x27;quantity&#x27;: 1,</span><br><span class="line">                    &#x27;price&#x27;: 100,</span><br><span class="line">                &#125;]</span><br><span class="line">            &#125;],</span><br><span class="line">            &#x27;redirectUrls&#x27;: &#123;</span><br><span class="line">                &#x27;confirmUrl&#x27;: f&quot;https://&#123;env(&#x27;HOSTNAME&#x27;)&#125;/payment/confirm&quot;,</span><br><span class="line">                &#x27;cancelUrl&#x27;: f&quot;https://&#123;env(&#x27;HOSTNAME&#x27;)&#125;/payment/cancel&quot;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    else:</span><br><span class="line">        return render(request, &quot;payment/checkout.html&quot;)</span><br></pre></td></tr></table></figure>


<h4 id="建立-headers"><a href="#建立-headers" class="headerlink" title="建立 headers"></a>建立 headers</h4><p>當我們把 body 做好後，就該來做 headers 了</p>
<p>先來看一下官方手冊吧</p>
<p><code>Content-Type</code> 指的是使用的資料格式<br><code>X-LINE-ChannelId</code> 填入剛剛申請的 Channel ID，這樣才知道是哪間商店<br><code>X-LINE-MerchantDeviceProfileId</code> 目前沒有實體店，略過<br><code>X-LINE-Authorization-Nonce</code> 是為了避免搞混多筆一樣的交易，所以多這個參數<br><code>X-LINE-Authorization</code> Hash 過後的交易及其他資料(包含 body)</p>
<p><img src="https://imgur.com/1DsAdiO.jpg" alt="LINE Pay Request Header"></p>
<p>我們先列出 header 必要的 key </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"># payment/views.py</span><br><span class="line"></span><br><span class="line">def create_headers(body, uri):</span><br><span class="line">    headers = &#123;</span><br><span class="line">        &#x27;Content-Type&#x27;: &#x27;application/json&#x27;,</span><br><span class="line">        &#x27;X-LINE-ChannelId&#x27;: &#x27;&#x27;,</span><br><span class="line">        &#x27;X-LINE-Authorization-Nonce&#x27;: &#x27;&#x27;,</span><br><span class="line">        &#x27;X-LINE-Authorization&#x27;: &#x27;&#x27;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    return headers</span><br></pre></td></tr></table></figure>

<h4 id="X-LINE-ChannelId"><a href="#X-LINE-ChannelId" class="headerlink" title="X-LINE-ChannelId"></a>X-LINE-ChannelId</h4><p>接著我們將 Channel Id 從環境變數取出作為 <code>X-LINE-ChannelId</code> 的 value</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"># payment/views.py</span><br><span class="line"></span><br><span class="line">def create_headers(body, uri):</span><br><span class="line">    channel_id = env(&#x27;LINE_CHANNEL_ID&#x27;)</span><br><span class="line"></span><br><span class="line">    headers = &#123;</span><br><span class="line">        &#x27;Content-Type&#x27;: &#x27;application/json&#x27;,</span><br><span class="line">        &#x27;X-LINE-ChannelId&#x27;: channel_id,</span><br><span class="line">        &#x27;X-LINE-Authorization-Nonce&#x27;: &#x27;&#x27;,</span><br><span class="line">        &#x27;X-LINE-Authorization&#x27;: &#x27;&#x27;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    return headers</span><br></pre></td></tr></table></figure>

<h4 id="X-LINE-Authorization-Nonce"><a href="#X-LINE-Authorization-Nonce" class="headerlink" title="X-LINE-Authorization-Nonce"></a>X-LINE-Authorization-Nonce</h4><p>再來製作一個 nonce ，目的在於區別各個交易</p>
<p>我們就用 uuid 來做吧</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"># payment/views.py</span><br><span class="line"></span><br><span class="line">def create_headers(body, uri):</span><br><span class="line">    ...</span><br><span class="line">    nonce = str(uuid.uuid4())</span><br><span class="line"></span><br><span class="line">    headers = &#123;</span><br><span class="line">        &#x27;Content-Type&#x27;: &#x27;application/json&#x27;,</span><br><span class="line">        &#x27;X-LINE-ChannelId&#x27;: channel_id,</span><br><span class="line">        &#x27;X-LINE-Authorization-Nonce&#x27;: nonce,</span><br><span class="line">        &#x27;X-LINE-Authorization&#x27;: &#x27;&#x27;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    return headers</span><br></pre></td></tr></table></figure>


<h4 id="X-LINE-Authorization"><a href="#X-LINE-Authorization" class="headerlink" title="X-LINE-Authorization"></a>X-LINE-Authorization</h4><p>headers 中以 <code>X-LINE-Authorization</code> 處理起來比較耗費心力一點</p>
<p>我們先來看一下官方手冊給的公式</p>
<blockquote>
<p>Signature &#x3D; Base64(HMAC-SHA256(Your ChannelSecret, (Your ChannelSecret + URI + RequestBody + nonce)))</p>
</blockquote>
<p><code>Your ChannelSecret</code> 是我們剛剛申請的 Channel Secret Key </p>
<p><code>URI</code> 由於我們是打 Request API，所以這邊指的是 <code>/v3/payments/request</code><br><strong>要注意，不需要加上 Sandbox 的 URL</strong></p>
<p><code>RequestBody</code> 我們剛剛組合的 body (也就是 payload)</p>
<p><code>nonce</code> 可使用 uuid 或 timestamp 產生</p>
<p>我們先將這四個資料找出來，並且串起來</p>
<h4 id="secret-key"><a href="#secret-key" class="headerlink" title="secret_key"></a>secret_key</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"># payment/views.py</span><br><span class="line"></span><br><span class="line">def create_headers(body, uri):</span><br><span class="line">    ...</span><br><span class="line">    secret_key = env(&#x27;LINE_CHANNEL_SECRET_KEY&#x27;)</span><br><span class="line">    </span><br><span class="line"></span><br><span class="line">    headers = &#123;</span><br><span class="line">        &#x27;Content-Type&#x27;: &#x27;application/json&#x27;,</span><br><span class="line">        &#x27;X-LINE-ChannelId&#x27;: channel_id,</span><br><span class="line">        &#x27;X-LINE-Authorization-Nonce&#x27;: nonce,</span><br><span class="line">        &#x27;X-LINE-Authorization&#x27;: &#x27;&#x27;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    return headers</span><br></pre></td></tr></table></figure>

<h4 id="uri-body"><a href="#uri-body" class="headerlink" title="uri &#x2F; body"></a>uri &#x2F; body</h4><p>由於 Confirm API 也會需要用該方法建立 header </p>
<p>所以 body 與 uri 就用引數</p>
<p>我們要在呼叫 <code>create_headers</code> 方法時帶入</p>
<p>uri 已經存在環境變數 <code>LINE_SIGNATURE_REQUEST_URI</code>中了，所以將他叫出來即可，要注意值是 <code>/v3/payments/request</code></p>
<p>body 則是我們一開始組裝的 payload</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"># payment/views.py</span><br><span class="line"></span><br><span class="line">def request(request):</span><br><span class="line">    if request.method == &quot;POST&quot;:</span><br><span class="line">        ...</span><br><span class="line"></span><br><span class="line">        payload = &#123;</span><br><span class="line">            ...</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        signature_uri = env(&#x27;LINE_SIGNATURE_REQUEST_URI&#x27;)        </span><br><span class="line">        headers = create_headers(payload, signature_uri)</span><br><span class="line"></span><br><span class="line">    else:</span><br><span class="line">        return render(request, &quot;payment/checkout.html&quot;)</span><br></pre></td></tr></table></figure>

<p>因為 headers 的 Content-Type 格式是 application&#x2F;json<br>所以當 body 要記得轉成 json 格式</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"># payment/views.py</span><br><span class="line"></span><br><span class="line">import json</span><br><span class="line">...</span><br><span class="line"></span><br><span class="line">def create_headers(body, uri):</span><br><span class="line">    ...</span><br><span class="line">    body_to_json = json.dumps(body)</span><br><span class="line"></span><br><span class="line">    headers = &#123;</span><br><span class="line">        &#x27;Content-Type&#x27;: &#x27;application/json&#x27;,</span><br><span class="line">        &#x27;X-LINE-ChannelId&#x27;: channel_id,</span><br><span class="line">        &#x27;X-LINE-Authorization-Nonce&#x27;: nonce,</span><br><span class="line">        &#x27;X-LINE-Authorization&#x27;: &#x27;&#x27;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    return headers</span><br></pre></td></tr></table></figure>

<h4 id="nonce"><a href="#nonce" class="headerlink" title="nonce"></a>nonce</h4><p>我們可以用剛剛做出來的 nonce ，這邊就不需要再另外做了</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"># payment/views.py</span><br><span class="line"></span><br><span class="line">def create_headers(body, uri):</span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line">    headers = &#123;</span><br><span class="line">        &#x27;Content-Type&#x27;: &#x27;application/json&#x27;,</span><br><span class="line">        &#x27;X-LINE-ChannelId&#x27;: channel_id,</span><br><span class="line">        &#x27;X-LINE-Authorization-Nonce&#x27;: nonce,</span><br><span class="line">        &#x27;X-LINE-Authorization&#x27;: &#x27;&#x27;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    return headers</span><br></pre></td></tr></table></figure>

<h4 id="組裝成-message"><a href="#組裝成-message" class="headerlink" title="組裝成 message"></a>組裝成 message</h4><p>Signature 公式</p>
<blockquote>
<p>Signature &#x3D; Base64(HMAC-SHA256(Your ChannelSecret, (Your ChannelSecret + URI + RequestBody + nonce)))</p>
</blockquote>
<p>四個資料都準備好後，就可以把他們組裝起來了</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"># payment/views.py</span><br><span class="line"></span><br><span class="line">def create_headers(body, uri):</span><br><span class="line">    ...</span><br><span class="line">    nonce = str(uuid.uuid4())</span><br><span class="line">    secret_key = env(&#x27;LINE_CHANNEL_SECRET_KEY&#x27;)</span><br><span class="line">    body_to_json = json.dumps(body)</span><br><span class="line">    message = secret_key + uri + body_to_json + nonce</span><br><span class="line"></span><br><span class="line">    headers = &#123;</span><br><span class="line">        &#x27;Content-Type&#x27;: &#x27;application/json&#x27;,</span><br><span class="line">        &#x27;X-LINE-ChannelId&#x27;: channel_id,</span><br><span class="line">        &#x27;X-LINE-Authorization-Nonce&#x27;: nonce,</span><br><span class="line">        &#x27;X-LINE-Authorization&#x27;: &#x27;&#x27;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    return headers</span><br></pre></td></tr></table></figure>

<h4 id="對-message-及-secret-key-做-hash"><a href="#對-message-及-secret-key-做-hash" class="headerlink" title="對 message 及 secret_key 做 hash"></a>對 message 及 secret_key 做 hash</h4><p>我們再來看一下官方手冊給的公式</p>
<blockquote>
<p>Signature &#x3D; Base64(HMAC-SHA256(Your ChannelSecret, (Your ChannelSecret + URI + RequestBody + nonce)))</p>
</blockquote>
<p>組起來後我們就要先來對這包資料做 HMAC</p>
<p>HMAC 是一種雜湊方式，可以保有完整資料，而且也可以拿來做身份的驗證</p>
<p>我們在傳送資料的過程中，隨時有可能會被有心人士更改，</p>
<p>將資料加上雜湊，可以讓資料難以被更改以外</p>
<p>也可以透過解析來做身份驗證<br>(判斷接收方與發送方計算出來的是否一致)</p>
<p>由於 hmac 方法只接受 bytes 或 bytearray 資料</p>
<h4 id="改資料為-bytes"><a href="#改資料為-bytes" class="headerlink" title="改資料為 bytes"></a>改資料為 bytes</h4><p>所以我們得先將 secret_key 與 message 轉為 bytes 格式</p>
<p><code>encode</code> 會將字串轉換格式，預設是轉換為 <code>utf-8</code> </p>
<p>UTF-8 編碼是將字串轉為位元組的方式</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"># payment/views.py</span><br><span class="line"></span><br><span class="line">def create_headers(body, uri):</span><br><span class="line">    ...</span><br><span class="line">    secret_key = env(&#x27;LINE_CHANNEL_SECRET_KEY&#x27;)</span><br><span class="line">    body_to_json = json.dumps(body)</span><br><span class="line">    nonce = str(uuid.uuid4())</span><br><span class="line">    message = secret_key + uri + body_to_json + nonce</span><br><span class="line">    </span><br><span class="line">    binary_message = message.encode()</span><br><span class="line">    binary_secret_key = secret_key.encode()</span><br><span class="line"></span><br><span class="line">    headers = &#123;</span><br><span class="line">        &#x27;Content-Type&#x27;: &#x27;application/json&#x27;,</span><br><span class="line">        &#x27;X-LINE-ChannelId&#x27;: channel_id,</span><br><span class="line">        &#x27;X-LINE-Authorization-Nonce&#x27;: nonce,</span><br><span class="line">        &#x27;X-LINE-Authorization&#x27;: &#x27;&#x27;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    return headers</span><br></pre></td></tr></table></figure>

<h4 id="HMAC-處理"><a href="#HMAC-處理" class="headerlink" title="HMAC 處理"></a>HMAC 處理</h4><p>Signature 公式</p>
<blockquote>
<p>Signature &#x3D; Base64(HMAC-SHA256(Your ChannelSecret, (Your ChannelSecret + URI + RequestBody + nonce)))</p>
</blockquote>
<p>hmac 第一個引數為 key ，這邊我們要放 binary_secret_key</p>
<p>第二個引數為 message，要放 binary_message</p>
<p>第三個引數為雜湊模式，要用 SHA256 的方式雜湊，第三個參數要加上 <code>hashlib.sha256</code></p>
<blockquote>
<p>hmac.new(key, msg&#x3D;None, digestmod)</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"># payment/views.py</span><br><span class="line"></span><br><span class="line">import hmac</span><br><span class="line">import hashlib</span><br><span class="line"></span><br><span class="line">...</span><br><span class="line"></span><br><span class="line">def create_headers(body, uri):</span><br><span class="line">    ...</span><br><span class="line">    secret_key = env(&#x27;LINE_CHANNEL_SECRET_KEY&#x27;)</span><br><span class="line">    body_to_json = json.dumps(body)</span><br><span class="line">    nonce = str(uuid.uuid4())</span><br><span class="line">    message = secret_key + uri + body_to_json + nonce</span><br><span class="line">    </span><br><span class="line">    binary_message = message.encode()</span><br><span class="line">    binary_secret_key = secret_key.encode()</span><br><span class="line">    </span><br><span class="line">    hash = hmac.new(binary_secret_key, binary_message, hashlib.sha256)</span><br><span class="line"></span><br><span class="line">    headers = &#123;</span><br><span class="line">        &#x27;Content-Type&#x27;: &#x27;application/json&#x27;,</span><br><span class="line">        &#x27;X-LINE-ChannelId&#x27;: channel_id,</span><br><span class="line">        &#x27;X-LINE-Authorization-Nonce&#x27;: nonce,</span><br><span class="line">        &#x27;X-LINE-Authorization&#x27;: &#x27;&#x27;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    return headers</span><br></pre></td></tr></table></figure>

<h4 id="Base-64"><a href="#Base-64" class="headerlink" title="Base 64"></a>Base 64</h4><p>Signature 公式</p>
<blockquote>
<p>Signature &#x3D; Base64(HMAC-SHA256(Your ChannelSecret, (Your ChannelSecret + URI + RequestBody + nonce)))</p>
</blockquote>
<p>Base64常用於處理文字資料，可用來傳輸</p>
<p>如想了解更細部的資訊，可參閱 <a href="xhttps://zh.wikipedia.org/wiki/Base64">Base64</a></p>
<p>做好就可以作為 <code>X-LINE-Authorization</code> 的 value 了</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"># payment/views.py</span><br><span class="line"></span><br><span class="line">import base64</span><br><span class="line">...</span><br><span class="line"></span><br><span class="line">def create_headers(body, uri):</span><br><span class="line">    ...</span><br><span class="line">    secret_key = env(&#x27;LINE_CHANNEL_SECRET_KEY&#x27;)</span><br><span class="line">    body_to_json = json.dumps(body)</span><br><span class="line">    nonce = str(uuid.uuid4())</span><br><span class="line">    message = secret_key + uri + body_to_json + nonce</span><br><span class="line">    </span><br><span class="line">    binary_message = message.encode()</span><br><span class="line">    binary_secret_key = secret_key.encode()</span><br><span class="line">    </span><br><span class="line">    hash = hmac.new(binary_secret_key, binary_message, hashlib.sha256)</span><br><span class="line">    </span><br><span class="line">    signature = base64.b64encode(hash.digest()).decode()</span><br><span class="line"></span><br><span class="line">    headers = &#123;</span><br><span class="line">        &#x27;Content-Type&#x27;: &#x27;application/json&#x27;,</span><br><span class="line">        &#x27;X-LINE-ChannelId&#x27;: channel_id,</span><br><span class="line">        &#x27;X-LINE-Authorization-Nonce&#x27;: nonce,</span><br><span class="line">        &#x27;X-LINE-Authorization&#x27;: signature</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    return headers</span><br></pre></td></tr></table></figure>


<h4 id="打-API-囉！"><a href="#打-API-囉！" class="headerlink" title="打 API 囉！"></a>打 API 囉！</h4><p>我們將 headers 處理好後，</p>
<p>接著將 body 轉為 json </p>
<p>並且設定好要打的 url (請用環境變數存放) 為 <code>https://sandbox-api-pay.line.me/v3/payments/request</code></p>
<p>就可以打 API 出去了</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"># payment/views.py</span><br><span class="line"></span><br><span class="line">import requests</span><br><span class="line">...</span><br><span class="line"></span><br><span class="line">def request(request):</span><br><span class="line">    if request.method == &quot;POST&quot;:</span><br><span class="line">        url = f&quot;&#123;env(&#x27;LINE_SANDBOX_URL&#x27;)&#125;&#123;env(&#x27;LINE_REQUEST_URL&#x27;)&#125;&quot;</span><br><span class="line">        ...</span><br><span class="line">        body = json.dumps(payload)</span><br><span class="line"></span><br><span class="line">        response = requests.post(url, headers=headers, data=body)</span><br><span class="line"></span><br><span class="line">    else:</span><br><span class="line">        return render(request, &quot;payment/checkout.html&quot;)</span><br></pre></td></tr></table></figure>

<h3 id="接收-response"><a href="#接收-response" class="headerlink" title="接收 response"></a>接收 response</h3><p>打過去 Request API 後，會回傳一包 response </p>
<p>這時候 LINE Pay 的付款頁面就會在這包裡面</p>
<p>我們要將 response 解析</p>
<p>成功的回傳代碼是 <code>0000</code></p>
<p>如成功的話，將頁面網址找出來再 redirect 過去</p>
<p>失敗的話就印出回傳訊息</p>
<p>而付款頁面是放在 info 的 paymentUrl 的 web</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"># payment/views.py</span><br><span class="line"></span><br><span class="line">def request(request):</span><br><span class="line">    if request.method == &quot;POST&quot;:</span><br><span class="line">        url = f&quot;&#123;env(&#x27;LINE_SANDBOX_URL&#x27;)&#125;&#123;env(&#x27;LINE_REQUEST_URL&#x27;)&#125;&quot;</span><br><span class="line">        ...</span><br><span class="line"></span><br><span class="line">        response = requests.post(url, headers=headers, data=body)</span><br><span class="line">        </span><br><span class="line">        if response.status_code == 200:</span><br><span class="line">            data = response.json()</span><br><span class="line">            if data[&#x27;returnCode&#x27;] == &#x27;0000&#x27;:</span><br><span class="line">                return redirect(data[&#x27;info&#x27;][&#x27;paymentUrl&#x27;][&#x27;web&#x27;])</span><br><span class="line">            else:</span><br><span class="line">                print(data[&#x27;returnMessage&#x27;])</span><br><span class="line">                return render(request, &quot;payment/checkout.html&quot;)</span><br><span class="line">        else:</span><br><span class="line">            print(f&#x27;Error: &#123;response.status_code&#125;&#x27;)</span><br><span class="line">            return render(request, &quot;payment/checkout.html&quot;)</span><br><span class="line"></span><br><span class="line">    else:</span><br><span class="line">        return render(request, &quot;payment/checkout.html&quot;)</span><br></pre></td></tr></table></figure>

<h3 id="設定-CSRF-以及-ALLOWED-HOST"><a href="#設定-CSRF-以及-ALLOWED-HOST" class="headerlink" title="設定 CSRF 以及 ALLOWED_HOST"></a>設定 CSRF 以及 ALLOWED_HOST</h3><p>由於我這邊使用 NGROK ，是外部的服務</p>
<p>除了要告訴 Djanog 哪些域名是可以被訪問的以外</p>
<p>還要避免偽造請求</p>
<p>所以需要再額外設定 CSRF 與 ALLOWED_HOST</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"># core/settings.py</span><br><span class="line"></span><br><span class="line">ALLOWED_HOSTS = [</span><br><span class="line">    env(&#x27;HOSTNAME&#x27;)</span><br><span class="line">]</span><br><span class="line"></span><br><span class="line">CSRF_TRUSTED_ORIGINS = [</span><br><span class="line">    f&quot;https://&#123;env(&#x27;HOSTNAME&#x27;)&#125;&quot;,</span><br><span class="line">]</span><br></pre></td></tr></table></figure>

<p>到這邊應該就可以前進 LINE Pay 付款了</p>
<p><img src="https://imgur.com/y5sCFQa.jpg" alt="LINE Pay"></p>
<p>手機掃描付款畫面</p>
<p><img src="https://imgur.com/OoA0eWb.jpg" alt="LINE Pay"></p>
<h2 id="Step-3-向-LINE-Pay-申請完成交易"><a href="#Step-3-向-LINE-Pay-申請完成交易" class="headerlink" title="Step 3. 向 LINE Pay 申請完成交易"></a>Step 3. 向 LINE Pay 申請完成交易</h2><p>付款申請差不多到這邊，接著消費者完成交易後，店家這邊需要再做確認</p>
<p>所以再來要打 Confirm API</p>
<p>由於處理方式跟 Request API 差不多，類似的地方我就不多做介紹</p>
<h4 id="設定-urls-與-views-1"><a href="#設定-urls-與-views-1" class="headerlink" title="設定 urls 與 views"></a>設定 urls 與 views</h4><p>一樣設定 urls 與 views </p>
<p>當使用者付款成功後，會馬上轉到 confirm 的 url 去完成交易</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"># payment/urls.py</span><br><span class="line"></span><br><span class="line">from django.contrib import admin</span><br><span class="line">from django.urls import path</span><br><span class="line">from . import views</span><br><span class="line"></span><br><span class="line">app_name = &quot;payment&quot;</span><br><span class="line"></span><br><span class="line">urlpatterns = [</span><br><span class="line">    path(&#x27;request&#x27;, views.request, name=&#x27;request&#x27;),</span><br><span class="line">    path(&#x27;confirm&#x27;, views.confirm, name=&quot;confirm&quot;),</span><br><span class="line">]</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>記得也要加入 templates</p>
<h4 id="組裝-request-需要的-headers-body-1"><a href="#組裝-request-需要的-headers-body-1" class="headerlink" title="組裝 request 需要的 headers &amp; body"></a>組裝 request 需要的 headers &amp; body</h4><p>官方手冊 Request API 的規格</p>
<p>方法 <code>POST</code><br>URL <code>/v3/payments/&#123;transactionId&#125;/confirm</code></p>
<p>在組裝 headers 與 body 以前，我們要先拿到該筆交易的 id 讓 LINE Pay 與我們辨認</p>
<h3 id="拿到-transaction-id-與-order-id"><a href="#拿到-transaction-id-與-order-id" class="headerlink" title="拿到 transaction_id 與 order_id"></a>拿到 transaction_id 與 order_id</h3><p>Confirm API 的 url 需要包含 transaction_id </p>
<p>LINE Pay 才會知道是要確認哪筆款項</p>
<p>所以我們要從 requests 中找到 <code>transactionId</code></p>
<p>orderId 則是方便我們從資料庫中找出資料，並針對該訂單進行更新</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"># payment/views.py</span><br><span class="line"></span><br><span class="line">def confirm(request):</span><br><span class="line">    transaction_id = request.GET.get(&#x27;transactionId&#x27;)</span><br><span class="line">    order_id = request.GET.get(&#x27;orderId&#x27;)</span><br></pre></td></tr></table></figure>

<h3 id="組裝-body"><a href="#組裝-body" class="headerlink" title="組裝 body"></a>組裝 body</h3><p>打 Confirm API 一樣需要組裝 body </p>
<p>只要包含 amount 與 currency 即可</p>
<p>這邊需要去資料庫中撈出該筆 order_id 的資料，並且將 amount 填進去</p>
<p>不過展示所以就先寫假資料</p>
<p><img src="https://imgur.com/sUfSctm.jpg" alt="LINE Pay Confirm"></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"># payment/views.py</span><br><span class="line"></span><br><span class="line">def confirm(request):</span><br><span class="line">    transaction_id = request.GET.get(&#x27;transactionId&#x27;)</span><br><span class="line">    order_id = request.GET.get(&#x27;orderId&#x27;)</span><br><span class="line">    </span><br><span class="line">    payload = &#123;</span><br><span class="line">        &#x27;amount&#x27;: 100,</span><br><span class="line">        &#x27;currency&#x27;: &#x27;TWD&#x27;,</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<h3 id="建立-headers-1"><a href="#建立-headers-1" class="headerlink" title="建立 headers"></a>建立 headers</h3><p>跟剛剛的 Request API 一樣</p>
<p>只要將 body 與 uri 做為參數傳進去即可</p>
<p>要記得 uri 要塞 transaction_id 進去 <code>/v3/payments/&#123;transaction_id&#125;/confirm</code></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"># payment/views.py</span><br><span class="line"></span><br><span class="line">def confirm(request):</span><br><span class="line">    transaction_id = request.GET.get(&#x27;transactionId&#x27;)</span><br><span class="line">    order_id = request.GET.get(&#x27;orderId&#x27;)</span><br><span class="line">    </span><br><span class="line">    payload = &#123;</span><br><span class="line">        &#x27;amount&#x27;: 100,</span><br><span class="line">        &#x27;currency&#x27;: &#x27;TWD&#x27;,</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    signature_uri = f&quot;/v3/payments/&#123;transaction_id&#125;/confirm&quot;</span><br><span class="line">    headers = create_headers(payload, signature_uri)</span><br></pre></td></tr></table></figure>

<h3 id="發送-reqeust-到-Confirm-API"><a href="#發送-reqeust-到-Confirm-API" class="headerlink" title="發送 reqeust 到 Confirm API"></a>發送 reqeust 到 Confirm API</h3><p>將 body 轉成 json 格式後</p>
<p>設定 url 後，就可以打 API 過去了</p>
<p>url 的網址為 <code>https://sandbox-api-pay.line.me/v3/payments/&#123;transaction_id&#125;/confirm</code></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"># payment/views.py</span><br><span class="line"></span><br><span class="line">def confirm(request):</span><br><span class="line">    transaction_id = request.GET.get(&#x27;transactionId&#x27;)</span><br><span class="line">    order_id = request.GET.get(&#x27;orderId&#x27;)</span><br><span class="line">    url = f&quot;&#123;env(&#x27;LINE_SANDBOX_URL&#x27;)&#125;/v3/payments/&#123;transaction_id&#125;/confirm&quot;</span><br><span class="line">    </span><br><span class="line">    body = json.dumps(payload)</span><br><span class="line"></span><br><span class="line">    response = requests.post(uri, headers=headers, data=body)</span><br></pre></td></tr></table></figure>

<h4 id="解析-response"><a href="#解析-response" class="headerlink" title="解析 response"></a>解析 response</h4><p>這邊的步驟也跟 Request API 一樣</p>
<p><code>returnCode</code> 成功為 <code>0000</code></p>
<p>如果是 0000 的話就轉到付款成功頁面</p>
<p>失敗就轉至失敗頁面，並可設定錯誤訊息</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"># payment/views.py</span><br><span class="line"></span><br><span class="line">def confirm(request):</span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line">    response = requests.post(uri, headers=headers, data=body)</span><br><span class="line">    </span><br><span class="line">    data = response.json()</span><br><span class="line">    if data[&#x27;returnCode&#x27;] == &#x27;0000&#x27;:</span><br><span class="line">        return render(request, &quot;payment/success.html&quot;)</span><br><span class="line">    else:</span><br><span class="line">        print(data[&#x27;returnMessage&#x27;])</span><br><span class="line">        return render(request, &quot;payment/fail.html&quot;)</span><br></pre></td></tr></table></figure>

<p>到這邊就差不多囉，接著就把 success 與 fail 的 urls &#x2F; views &#x2F; templates 補上就可以囉</p>
<p>如果我們一開始在打 Request API 的時候沒有設定 options.payment.capture 為 false 的話，到這步就完成了</p>
<p>如果設定為 false 的話，狀態會保持 <code>待請款（授權）</code> ，必須要再打 <code>Capture API</code></p>
<p>如果這篇文章對你有幫助的話，歡迎按讚或留言</p>
<p>有任何想討論的，也歡迎底下留言給我唷</p>
</div><div class="post-footer"><div class="meta"><div class="info"><i class="fa fa-sun-o"></i><span class="date">2024-06-10</span><i class="fa fa-tag"></i><a class="tag" href="/categories/Django/" title="Django">Django </a></div></div></div></div><div class="share"><div class="evernote"><a class="fa fa-bookmark" href="javascript:(function(){EN_CLIP_HOST='http://www.evernote.com';try{var%20x=document.createElement('SCRIPT');x.type='text/javascript';x.src=EN_CLIP_HOST+'/public/bookmarkClipper.js?'+(new%20Date().getTime()/100000);document.getElementsByTagName('head')[0].appendChild(x);}catch(e){location.href=EN_CLIP_HOST+'/clip.action?url='+encodeURIComponent(location.href)+'&amp;title='+encodeURIComponent(document.title);}})();" ref="nofollow" target="_blank"></a></div><div class="twitter"><a class="fa fa-twitter" target="_blank" rel="noopener" href="http://twitter.com/home?status=,http://ninglab.com/Django-line-pay/,NingLab,Django - LINE Pay 串接實戰,;"></a></div></div><div><script src="https://utteranc.es/client.js" repo="cacachang/cacachang.github.io" issue-term="title" theme="github-light" crossorigin="anonymous" async></script></div><div><script type="text/javascript">document.write("<iframe scrolling='no' frameborder='0' sandbox='allow-scripts allow-same-origin allow-popups allow-popups-to-escape-sandbox allow-storage-access-by-user-activation' style='height: 212px; width: 100%;' src='https://button.like.co/in/embed/a24701770/button?referrer=" + encodeURIComponent(location.href.split("?")[0].split("#")[0]) + "'></iframe>");</script></div><div class="pagination"><ul class="clearfix"><li class="pre pagbuttons"><a class="btn" role="navigation" href="/AWS-vpc-and-public-subnet/" title="AWS 小探險 - 建立 VPC 與 Public Subnet">上一篇</a></li><li class="next pagbuttons"><a class="btn" role="navigation" href="/Python-methods/" title="Python - 實體方法與類別方法的小故事">下一篇</a></li></ul></div></div></div></div></div><script src="/js/jquery.js"></script><script src="/js/jquery-migrate-1.2.1.min.js"></script><script src="/js/jquery.appear.js"></script></body></html>