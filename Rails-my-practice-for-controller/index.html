<!DOCTYPE html><html lang="zh-TW"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><meta name="author"><title>Rails 實作應用 - Controller 篇 · NingLab</title><meta name="description" content="Controller針對 View 的需求，跟 model 拿資料再回來處理這些資料
Routes 會指引到對應的 Controller 及 action12Prefix  Verb   URI Pattern                   Controller#Actionblogs   G"><meta name="keywords"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><script async src="https://www.googletagmanager.com/gtag/js?id=G-4P2R013PGL"></script><script>window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'G-4P2R013PGL')
</script><meta name="renderer" content="webkit"><link rel="short icon" href="/images/favicon.jpeg" type="image/x-icon"><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="/css/blog_basic.css"><link rel="stylesheet" href="/css/font-awesome.min.css"><link rel="alternate" type="application/atom+xml" title="ATOM 1.0" href="/atom.xml"><meta name="generator" content="Hexo 7.1.1"></head><body><div class="sidebar animated fadeInDown"><div class="logo-title"><div class="title"><img src="/images/ning.jpg" style="width:200px;"><h3 title=""><a href="/">NingLab</a></h3></div></div><ul class="social-links"><li><a target="_blank" rel="noopener" href="https://twitter.com/ningchang_"><i class="fa fa-twitter"></i></a></li><li><a target="_blank" rel="noopener" href="https://github.com/cacachang"><i class="fa fa-github"></i></a></li><li><a href="mailto:a24701770@gmail.com"><i class="fa fa-envelope"></i></a></li><li><a target="_blank" rel="noopener" href="https://www.instagram.com/web543_/"><i class="fa fa-instagram"></i></a></li><li><a target="_blank" rel="noopener" href="https://www.linkedin.com/in/cacachang/"><i class="fa fa-linkedin"></i></a></li><li><a target="_blank" rel="noopener" href="https://www.youtube.com/channel/UCwRiNPzYITZWaif23HTmHZQ"><i class="fa fa-youtube"></i></a></li></ul><div class="footer"><div class="by_farbox"><a href="https://hexo.io/zh-cn/" target="_blank">Proudly published with Hexo&#65281;</a></div></div></div><div class="main"><div class="page-top animated fadeInDown"><div class="nav"><li><a href="/">首頁</a></li><li><a href="/archives">文章</a></li><li><a href="/categories">目錄</a></li><li><a href="/about">關於 Ning</a></li></div><div class="information"><div class="back_btn"><li><a class="fa fa-chevron-left" onclick="window.history.go(-1)"> </a></li></div><div class="avatar"><img src="/images/favicon.jpeg"></div></div></div><div class="autopagerize_page_element"><div class="content"><div class="post-page"><div class="post animated fadeInDown"><div class="post-title"><h3><a>Rails 實作應用 - Controller 篇</a></h3></div><div class="post-content"><h3 id="Controller"><a href="#Controller" class="headerlink" title="Controller"></a>Controller</h3><p>針對 View 的需求，跟 model 拿資料<br>再回來處理這些資料</p>
<h4 id="Routes-會指引到對應的-Controller-及-action"><a href="#Routes-會指引到對應的-Controller-及-action" class="headerlink" title="Routes 會指引到對應的 Controller 及 action"></a>Routes 會指引到對應的 Controller 及 action</h4><figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">Prefix</span>  <span class="title class_">Verb</span>   <span class="variable constant_">URI</span> <span class="title class_">Pattern</span>                   <span class="title class_">Controller</span><span class="comment">#Action</span></span><br><span class="line">blogs   <span class="variable constant_">GET</span>    /@<span class="symbol">:handler/blogs</span>(.<span class="symbol">:format</span>)    blogs<span class="comment">#show</span></span><br></pre></td></tr></table></figure>

<h4 id="全站都會用到的方法，就放-ApplicationController"><a href="#全站都會用到的方法，就放-ApplicationController" class="headerlink" title="全站都會用到的方法，就放 ApplicationController"></a>全站都會用到的方法，就放 ApplicationController</h4><figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">ApplicationController</span> &lt; <span class="title class_ inherited__">ActionController::Base</span></span><br><span class="line">  <span class="keyword">def</span> <span class="title function_">authenticta_user</span></span><br><span class="line">    redirect_to sign_in_users_path <span class="keyword">if</span> <span class="keyword">not</span> user_sign_in?</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<h4 id="private-method"><a href="#private-method" class="headerlink" title="private method"></a>private method</h4><p>僅限於 此 Controller 採用的方法</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span></span><br><span class="line">  <span class="keyword">def</span> <span class="title function_">encrypt_password</span></span><br><span class="line">    <span class="keyword">require</span> <span class="string">&#x27;digest&#x27;</span></span><br><span class="line">    pw = <span class="string">&quot;xx-<span class="subst">#&#123;<span class="variable language_">self</span>.password&#125;</span>-yy&quot;</span></span><br><span class="line">    <span class="variable language_">self</span>.password = <span class="title class_">Digest</span><span class="symbol">:</span><span class="symbol">:SHA1</span>.hexdigest(pw)</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<h3 id="功能應用"><a href="#功能應用" class="headerlink" title="功能應用"></a>功能應用</h3><h4 id="callback"><a href="#callback" class="headerlink" title="callback"></a>callback</h4><p>多個方法都會做的動作，就會拉出來做callback<br>動作通常會被放在private中</p>
<p>以下舉例</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># show、unlock方法，在執行前需要去找 article</span></span><br><span class="line">before_action <span class="symbol">:find_article</span>, <span class="symbol">only:</span> [<span class="symbol">:show</span>, <span class="symbol">:unlock</span>]</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">find_article</span></span><br><span class="line">  <span class="variable">@article</span> = <span class="title class_">Article</span>.find(params[<span class="symbol">:id</span>])</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>
<h4 id="清洗資料"><a href="#清洗資料" class="headerlink" title="清洗資料"></a>清洗資料</h4><figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 針對要資料做清洗，避免存入髒資料</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">params_article</span></span><br><span class="line">  params.<span class="keyword">require</span>(<span class="symbol">:article</span>).permit(<span class="symbol">:title</span>, <span class="symbol">:content</span>, <span class="symbol">:pincode</span>)</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 在一對多、多對多的關聯中，存入需要塞其他資料的話(像是 comment 存入前要有 user )，可以使用merge</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">comment_params</span></span><br><span class="line">  params.<span class="keyword">require</span>(<span class="symbol">:comment</span>).permit(<span class="symbol">:content</span>).merge(<span class="symbol">user:</span> current_user)</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<h4 id="軟刪除"><a href="#軟刪除" class="headerlink" title="軟刪除"></a>軟刪除</h4><p>講白話一點，就是這個刪除是演出來的<br>這筆資料並不會被刪除</p>
<p>那這筆資料到底發生了什麼事？<br>首先，我們會有 deleted_at 欄位<br>在刪除的時候把確切時間寫入<br>之後再將這筆資料隱藏起來</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># controller</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">destroy</span></span><br><span class="line">  <span class="variable">@article</span> = <span class="title class_">Article</span>.find(params[<span class="symbol">:id</span>])</span><br><span class="line">  <span class="comment"># 更新 deleted_at 的時間</span></span><br><span class="line">  <span class="variable">@article</span>.update(<span class="symbol">deleted_at:</span> <span class="title class_">Time</span>.current) </span><br><span class="line">    </span><br><span class="line">  redirect_to blogs_path, <span class="symbol">notice:</span> <span class="string">&quot;文章刪除成功&quot;</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># model</span></span><br><span class="line"><span class="comment"># 記得在 model 中做資料篩選，不然使用者刪除，卻還顯示在畫面就尷尬了</span></span><br><span class="line"><span class="comment"># default_scope 會在 model 中提到</span></span><br><span class="line"></span><br><span class="line">default_scope &#123; where(<span class="symbol">deleted_at:</span> <span class="literal">nil</span>) &#125;</span><br></pre></td></tr></table></figure>

<h4 id="session"><a href="#session" class="headerlink" title="session"></a>session</h4><p>當使用者登入時，我們需要發給他號碼牌<br>這時候我們就會用 session 來存使用者的 id<br>這個 session 會跟 cookie 核對並儲存</p>
<p>下次使用者再來<br>session跟cookie核對成功就不用再登入了</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">create</span></span><br><span class="line">  <span class="comment"># 使用者登入</span></span><br><span class="line">  user = <span class="title class_">User</span>.login(params[<span class="symbol">:user</span>])</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> user</span><br><span class="line">    <span class="comment"># session 會存在於瀏覽器的 cookie</span></span><br><span class="line">    session[<span class="symbol">:user_session</span>] = user.id</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> user.blog.present?</span><br><span class="line">       redirect_to <span class="string">&quot;/@<span class="subst">#&#123;user.blog.handler&#125;</span>&quot;</span>, <span class="symbol">notice:</span> <span class="string">&quot;登入成功&quot;</span></span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">       redirect_to new_blog_path , <span class="symbol">notice:</span> <span class="string">&quot;登入失敗，請先建立部落格&quot;</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">   <span class="comment"># 不能用 render，因為在 form_with 設定路徑是到 sessions</span></span><br><span class="line">   <span class="comment"># 如果去找 session，session 沒有 view，重新整理會壞掉</span></span><br><span class="line">   redirect_to <span class="string">&quot;/users/sign_in&quot;</span>, <span class="symbol">notice:</span> <span class="string">&quot;錯誤，請重新登入&quot;</span></span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<h3 id="記憶-memorization"><a href="#記憶-memorization" class="headerlink" title="記憶 memorization"></a>記憶 memorization</h3><p>為了減少資料庫的存取次數，我們可以在判斷時加上 ||&#x3D; 或 &amp;. </p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">current_user</span></span><br><span class="line">  <span class="comment"># 有 <span class="doctag">@user</span> 就回傳，沒有就繼續執行後面的條件</span></span><br><span class="line">  <span class="variable">@user</span> |<span class="params"></span>|= <span class="title class_">User</span>.find_by(<span class="symbol">id:</span> session[<span class="symbol">:user_session</span>])</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<h4 id="rescue-from"><a href="#rescue-from" class="headerlink" title="rescue_from"></a>rescue_from</h4><p>如果使用者按到沒有資料的頁面(例如 第2000筆user)<br>應出現 404 頁面<br>除了告訴使用者沒有這筆紀錄外<br>也要跟瀏覽器說這個頁面是錯誤的</p>
<p>rescue_from可以幫我們處理error的資料<br>避免使用者瀏覽的時候出現錯誤的畫面</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">ApplicationController</span> &lt; <span class="title class_ inherited__">ActionController::Base</span></span><br><span class="line">  rescue_from <span class="title class_">ActiveRecord</span><span class="symbol">:</span><span class="symbol">:RecordNotFound</span>, <span class="symbol">with:</span> <span class="symbol">:record_not_found</span></span><br><span class="line">    </span><br><span class="line">  <span class="keyword">private</span></span><br><span class="line">  <span class="keyword">def</span> <span class="title function_">record_not_found</span></span><br><span class="line">    <span class="comment"># file: 從根目錄去抓404檔案</span></span><br><span class="line">    <span class="comment"># layout: 不要套用全站layout(不然會有多餘的html)</span></span><br><span class="line">    <span class="comment"># status: 告訴瀏覽器頁面狀態，不然他會顯示2xx（正常的狀態）</span></span><br><span class="line">    render <span class="symbol">file:</span> <span class="string">&quot;<span class="subst">#&#123;<span class="title class_">Rails</span>.root&#125;</span>/public/404.html&quot;</span>, <span class="symbol">layout:</span> <span class="literal">false</span>, <span class="symbol">status:</span> <span class="number">404</span></span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<ul>
<li>額外補充：放在public的東西不會走正常流程的(routes)，怕伺服器出狀況，會連檔案都找不到</li>
</ul>
</div><div class="post-footer"><div class="meta"><div class="info"><i class="fa fa-sun-o"></i><span class="date">2022-08-21</span><i class="fa fa-tag"></i><a class="tag" href="/categories/Rails/" title="Rails">Rails </a></div></div></div></div><div class="share"><div class="evernote"><a class="fa fa-bookmark" href="javascript:(function(){EN_CLIP_HOST='http://www.evernote.com';try{var%20x=document.createElement('SCRIPT');x.type='text/javascript';x.src=EN_CLIP_HOST+'/public/bookmarkClipper.js?'+(new%20Date().getTime()/100000);document.getElementsByTagName('head')[0].appendChild(x);}catch(e){location.href=EN_CLIP_HOST+'/clip.action?url='+encodeURIComponent(location.href)+'&amp;title='+encodeURIComponent(document.title);}})();" ref="nofollow" target="_blank"></a></div><div class="twitter"><a class="fa fa-twitter" target="_blank" rel="noopener" href="http://twitter.com/home?status=,http://ninglab.com/Rails-my-practice-for-controller/,NingLab,Rails 實作應用 - Controller 篇,;"></a></div></div><div><script src="https://utteranc.es/client.js" repo="cacachang/cacachang.github.io" issue-term="title" theme="github-light" crossorigin="anonymous" async></script></div><div><script type="text/javascript">document.write("<iframe scrolling='no' frameborder='0' sandbox='allow-scripts allow-same-origin allow-popups allow-popups-to-escape-sandbox allow-storage-access-by-user-activation' style='height: 212px; width: 100%;' src='https://button.like.co/in/embed/a24701770/button?referrer=" + encodeURIComponent(location.href.split("?")[0].split("#")[0]) + "'></iframe>");</script></div><div class="pagination"><ul class="clearfix"><li class="pre pagbuttons"><a class="btn" role="navigation" href="/Rails-my-practice-for-model/" title="Rails 實作應用 - Model 篇">上一篇</a></li><li class="next pagbuttons"><a class="btn" role="navigation" href="/Rails-my-practice-for-router-and-view/" title="Rails 實作應用 - Route、View篇">下一篇</a></li></ul></div></div></div></div></div><script src="/js/jquery.js"></script><script src="/js/jquery-migrate-1.2.1.min.js"></script><script src="/js/jquery.appear.js"></script></body></html>