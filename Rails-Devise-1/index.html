<!DOCTYPE html><html lang="zh-TW"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><meta name="author"><title>叫我套件王 - 會員系統 Devise【1】 · NingLab</title><meta name="description" content="為什麼要用 Devise 支援多種會員系統模組 有許多方便的方法
前置作業：

建立一個 rails 專案 (本文章使用 7 版本)
安裝 devise gem

那我們就進入正題！
Step 1 把 devise 安裝起來1$ bundle add devise

1$ rails generat"><meta name="keywords"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="renderer" content="webkit"><link rel="short icon" href="/images/favicon.jpeg" type="image/x-icon"><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="/css/blog_basic.css"><link rel="stylesheet" href="/css/font-awesome.min.css"><link rel="alternate" type="application/atom+xml" title="ATOM 1.0" href="/atom.xml"><meta name="generator" content="Hexo 7.1.1"></head><body><div class="sidebar animated fadeInDown"><div class="logo-title"><div class="title"><img src="/images/ning.jpg" style="width:200px;"><h3 title=""><a href="/">NingLab</a></h3></div></div><ul class="social-links"><li><a target="_blank" rel="noopener" href="https://twitter.com/ningchang_"><i class="fa fa-twitter"></i></a></li><li><a target="_blank" rel="noopener" href="https://github.com/cacachang"><i class="fa fa-github"></i></a></li><li><a href="mailto:a24701770@gmail.com"><i class="fa fa-envelope"></i></a></li><li><a target="_blank" rel="noopener" href="https://www.instagram.com/web543_/"><i class="fa fa-instagram"></i></a></li><li><a target="_blank" rel="noopener" href="https://www.linkedin.com/in/%E7%8F%88%E5%AF%A7-%E5%BC%B5-140a86125/"><i class="fa fa-linkedin"></i></a></li></ul><div class="footer"><div class="by_farbox"><a href="https://hexo.io/zh-cn/" target="_blank">Proudly published with Hexo&#65281;</a></div></div></div><div class="main"><div class="page-top animated fadeInDown"><div class="nav"><li><a href="/">首頁</a></li><li><a href="/archives">文章</a></li><li><a href="/categories">目錄</a></li><li><a href="/about">關於 Ning</a></li></div><div class="information"><div class="back_btn"><li><a class="fa fa-chevron-left" onclick="window.history.go(-1)"> </a></li></div><div class="avatar"><img src="/images/favicon.jpeg"></div></div></div><div class="autopagerize_page_element"><div class="content"><div class="post-page"><div class="post animated fadeInDown"><div class="post-title"><h3><a>叫我套件王 - 會員系統 Devise【1】</a></h3></div><div class="post-content"><h3 id="為什麼要用-Devise"><a href="#為什麼要用-Devise" class="headerlink" title="為什麼要用 Devise"></a>為什麼要用 Devise</h3><p> 支援多種會員系統模組<br> 有許多方便的方法</p>
<p>前置作業：</p>
<ul>
<li>建立一個 rails 專案 (本文章使用 7 版本)</li>
<li>安裝 <a target="_blank" rel="noopener" href="https://github.com/heartcombo/devise">devise gem</a></li>
</ul>
<p>那我們就進入正題！</p>
<h4 id="Step-1-把-devise-安裝起來"><a href="#Step-1-把-devise-安裝起來" class="headerlink" title="Step 1 把 devise 安裝起來"></a>Step 1 把 devise 安裝起來</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ bundle add devise</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ rails generate devise:install</span><br></pre></td></tr></table></figure>
<p>這個指令會幫初始化 devise 跟產出 devise 的 i18n yml 設定檔</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">create  config/initializers/devise.rb</span><br><span class="line">create  config/locales/devise.en.yml</span><br></pre></td></tr></table></figure>

<p>會跳一大串的英文，不外乎就是在跟你說基本的設定等等等</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">Depending on your application&#x27;s configuration some manual setup may be required:</span><br><span class="line"></span><br><span class="line">  1. Ensure you have defined default url options in your environments files. Here</span><br><span class="line">     is an example of default_url_options appropriate for a development environment</span><br><span class="line">     in config/environments/development.rb:</span><br><span class="line"></span><br><span class="line">       config.action_mailer.default_url_options = &#123; host: &#x27;localhost&#x27;, port: 3000 &#125;</span><br><span class="line"></span><br><span class="line">     In production, :host should be set to the actual host of your application.</span><br><span class="line"></span><br><span class="line">     * Required for all applications. *</span><br><span class="line"></span><br><span class="line">  2. Ensure you have defined root_url to *something* in your config/routes.rb.</span><br><span class="line">     For example:</span><br><span class="line"></span><br><span class="line">       root to: &quot;home#index&quot;</span><br><span class="line">     </span><br><span class="line">     * Not required for API-only Applications *</span><br><span class="line"></span><br><span class="line">  3. Ensure you have flash messages in app/views/layouts/application.html.erb.</span><br><span class="line">     For example:</span><br><span class="line"></span><br><span class="line">       &lt;p class=&quot;notice&quot;&gt;&lt;%= notice %&gt;&lt;/p&gt;</span><br><span class="line">       &lt;p class=&quot;alert&quot;&gt;&lt;%= alert %&gt;&lt;/p&gt;</span><br><span class="line"></span><br><span class="line">     * Not required for API-only Applications *</span><br><span class="line"></span><br><span class="line">  4. You can copy Devise views (for customization) to your app by running:</span><br><span class="line"></span><br><span class="line">       rails g devise:views</span><br><span class="line">       </span><br><span class="line">     * Not required *</span><br></pre></td></tr></table></figure>

<p>devise 的安裝就大概完成囉</p>
<h4 id="Step-2-用-devise-產出-model"><a href="#Step-2-用-devise-產出-model" class="headerlink" title="Step 2 用 devise 產出 model"></a>Step 2 用 devise 產出 model</h4><p>如果今天 model 想叫 admin 或其他的，直接把 <code>User</code> 的地方改 <code>Admin</code> 或其他名字就可以了</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ rails generate devise User</span><br></pre></td></tr></table></figure>

<p>這個指令幫我們做出了 routes 及 model 及 migration 以及測試檔案</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">invoke  active_record</span><br><span class="line">create  db/migrate/20230430165603_devise_create_users.rb</span><br><span class="line">create  app/models/user.rb</span><br><span class="line">invoke  test_unit</span><br><span class="line">create  test/models/user_test.rb</span><br><span class="line">create  test/fixtures/users.yml</span><br><span class="line">insert  app/models/user.rb</span><br><span class="line">route  devise_for :users</span><br></pre></td></tr></table></figure>

<p>我們可以來看一下 user.rb 這個檔案</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"># Include default devise modules. Others available are:</span><br><span class="line"># :confirmable, :lockable, :timeoutable, :trackable and :omniauthable</span><br><span class="line">devise :database_authenticatable, :registerable,</span><br><span class="line">       :recoverable, :rememberable, :validatable</span><br></pre></td></tr></table></figure>

<p>devise 除了做出基本的會員註冊、登入功能，還包含了多種功能，依序介紹一下</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">confirmable: 發送註冊驗證信，並且在登入的時候，驗證使用者是否已經透過信件驗證</span><br><span class="line">lockable: 在登入失敗幾次後，會將使用者帳號鎖住</span><br><span class="line">timeoutable: 在一段時間內使用者沒有活動紀錄，就中止此 session</span><br><span class="line">trackable: 追蹤登入次數、時間及 IP 位置</span><br><span class="line">omniauthable: 第三方登入設定</span><br><span class="line">database_authenticatable: 針對密碼加密及儲存，會在使用者登入的時候做驗證</span><br><span class="line">registerable: 處理使用者的註冊流程，另外也提供編輯、刪除功能</span><br><span class="line">recoverable: 重設密碼功能</span><br><span class="line">rememberable: 透過 cookie 的資料來設定「記住我」</span><br><span class="line">validatable: 提供信箱及密碼的驗證機制，也可以另外自訂驗證</span><br></pre></td></tr></table></figure>

<p>假設我們今天要使用 confirmable 功能，那就必須把 :confirmable 解除註解，並且加到 <code>devise</code> 後方</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"># Include default devise modules. Others available are:</span><br><span class="line"># :lockable, :timeoutable, :trackable and :omniauthable</span><br><span class="line">devise :database_authenticatable, :registerable,</span><br><span class="line">            :recoverable, :rememberable, :validatable, :confirmable</span><br></pre></td></tr></table></figure>

<p>在做 migration 以前，也要將 migration 的 :confirmable 解除註解</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"># db/migrate/20230701155654_devise_create_users.rb</span><br><span class="line">    ...</span><br><span class="line">    ...</span><br><span class="line">    ...</span><br><span class="line">    # Confirmable</span><br><span class="line">    t.string   :confirmation_token</span><br><span class="line">    t.datetime :confirmed_at</span><br><span class="line">    t.datetime :confirmation_sent_at</span><br><span class="line">    t.string   :unconfirmed_email # Only if using reconfirmable</span><br><span class="line">    ...</span><br><span class="line">    ...</span><br><span class="line">    ...</span><br></pre></td></tr></table></figure>

<p>設定完成後我們就可以 migrate 了</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&gt; rails db:migrate</span><br></pre></td></tr></table></figure>

<p>然後重啟 server</p>
<h3 id="試試-Devise-的基本註冊功能"><a href="#試試-Devise-的基本註冊功能" class="headerlink" title="試試 Devise 的基本註冊功能"></a>試試 Devise 的基本註冊功能</h3><p>先來檢視一下 devise 為我們做出來的路徑</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&gt; rails routes -c devise</span><br></pre></td></tr></table></figure>
<p>注意這邊要用 devise 才會顯示出 devise 做出來的路徑</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">                  Prefix Verb   URI Pattern                    Controller#Action</span><br><span class="line">        new_user_session GET    /users/sign_in(.:format)       devise/sessions#new</span><br><span class="line">            user_session POST   /users/sign_in(.:format)       devise/sessions#create</span><br><span class="line">    destroy_user_session DELETE /users/sign_out(.:format)      devise/sessions#destroy</span><br><span class="line">       new_user_password GET    /users/password/new(.:format)  devise/passwords#new</span><br><span class="line">      edit_user_password GET    /users/password/edit(.:format) devise/passwords#edit</span><br><span class="line">           user_password PATCH  /users/password(.:format)      devise/passwords#update</span><br><span class="line">                         PUT    /users/password(.:format)      devise/passwords#update</span><br><span class="line">                         POST   /users/password(.:format)      devise/passwords#create</span><br><span class="line">cancel_user_registration GET    /users/cancel(.:format)        devise/registrations#cancel</span><br><span class="line">   new_user_registration GET    /users/sign_up(.:format)       devise/registrations#new</span><br><span class="line">  edit_user_registration GET    /users/edit(.:format)          devise/registrations#edit</span><br><span class="line">       user_registration PATCH  /users(.:format)               devise/registrations#update</span><br><span class="line">                         PUT    /users(.:format)               devise/registrations#update</span><br><span class="line">                         DELETE /users(.:format)               devise/registrations#destroy</span><br><span class="line">                         POST   /users(.:format)               devise/registrations#create</span><br></pre></td></tr></table></figure>

<p>接下來我們可以直接到會員註冊的路徑了</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://127.0.0.1:3000/users/sign_up</span><br></pre></td></tr></table></figure>

<p>貼到瀏覽器中會出現以下畫面</p>
<p><img src="https://i.imgur.com/y6RCOqN.png"></p>
<p>輸入註冊的 Email 及密碼就能註冊成功囉！</p>
<h3 id="devise-幫你做的方法"><a href="#devise-幫你做的方法" class="headerlink" title="devise 幫你做的方法"></a>devise 幫你做的方法</h3><p>Devise 有做出一些 controller 及 view 常見的方法<br>需要注意的是，假設 model 是 <code>Admin</code>，請記得要把方法的 <code>_user</code> 改成 <code>_admin</code> ，其他依此類推</p>
<h4 id="Controller-action"><a href="#Controller-action" class="headerlink" title="Controller action"></a>Controller action</h4><p>舉例來說，假設我們的網站是使用者登入才可以使用，我們可以在 application controller 中加入 <code>before_action :authenticate_user!</code><br>設定後，使用者要進入所有頁面前都需要先登入</p>
<h4 id="View-helper"><a href="#View-helper" class="headerlink" title="View helper"></a>View helper</h4><p>如果頁面中有特定區塊是使用者登入才看得到的，我們可以加入 <code>user_sign_in?</code> 在 view 裡面我們可以這樣寫：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;% if user_signed_in? %&gt;</span><br><span class="line">    已登入使用者才能看到的區塊</span><br><span class="line">&lt;% end %&gt;</span><br></pre></td></tr></table></figure>

<p>另一個更常見的 helper 是 <code>current_user</code><br>如果我們今天要在 view 顯示每個 user 的 email，就可以在 view 裡這樣寫：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;%= current_user.email %&gt;</span><br></pre></td></tr></table></figure>

<p>還有其他方法，要使用的話可以直接至 Devise 手冊翻閱<br>今天的介紹內容相對簡單，下一篇我們再繼續挖深一點！</p>
</div><div class="post-footer"><div class="meta"><div class="info"><i class="fa fa-sun-o"></i><span class="date">2024-02-22</span><i class="fa fa-tag"></i><a class="tag" href="/categories/Rails/" title="Rails">Rails </a></div></div></div></div><div class="share"><div class="evernote"><a class="fa fa-bookmark" href="javascript:(function(){EN_CLIP_HOST='http://www.evernote.com';try{var%20x=document.createElement('SCRIPT');x.type='text/javascript';x.src=EN_CLIP_HOST+'/public/bookmarkClipper.js?'+(new%20Date().getTime()/100000);document.getElementsByTagName('head')[0].appendChild(x);}catch(e){location.href=EN_CLIP_HOST+'/clip.action?url='+encodeURIComponent(location.href)+'&amp;title='+encodeURIComponent(document.title);}})();" ref="nofollow" target="_blank"></a></div><div class="twitter"><a class="fa fa-twitter" target="_blank" rel="noopener" href="http://twitter.com/home?status=,http://ninglab.com/Rails-Devise-1/,NingLab,叫我套件王 - 會員系統 Devise【1】,;"></a></div></div><div><script src="https://utteranc.es/client.js" repo="cacachang/cacachang.github.io" issue-term="title" theme="github-light" crossorigin="anonymous" async></script></div><div><script type="text/javascript">document.write("<iframe scrolling='no' frameborder='0' sandbox='allow-scripts allow-same-origin allow-popups allow-popups-to-escape-sandbox allow-storage-access-by-user-activation' style='height: 212px; width: 100%;' src='https://button.like.co/in/embed/a24701770/button?referrer=" + encodeURIComponent(location.href.split("?")[0].split("#")[0]) + "'></iframe>");</script></div><div class="pagination"><ul class="clearfix"><li class="pre pagbuttons"><a class="btn" role="navigation" href="/Rails-Master-Key/" title="Rails 的預設環境變數存取方式 - Master Key">上一篇</a></li><li class="next pagbuttons"><a class="btn" role="navigation" href="/Docker-Dockerfile-and-basic-command-2/" title="Docker - Dockerfile 基本介紹及指令">下一篇</a></li></ul></div></div></div></div></div><script src="/js/jquery.js"></script><script src="/js/jquery-migrate-1.2.1.min.js"></script><script src="/js/jquery.appear.js"></script></body></html>