<!DOCTYPE html><html lang="zh-TW"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><meta name="author"><title>SQL - Joins、Includes 差別在哪裡？ · NingLab</title><meta name="description" content="Join and Includes我們在開發的時候免不了關聯資料庫，在撈資料的時候也常常會需要用到 joins 跟 includes
所以，我們什麼時候會用到 joins 跟 includes
要尋找跟其他 model 有關聯的資料
避免 N + 1 問題

** N + 1 問題是什麼呢？當我們查"><meta name="keywords"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="renderer" content="webkit"><link rel="short icon" href="/images/favicon.jpeg" type="image/x-icon"><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="/css/blog_basic.css"><link rel="stylesheet" href="/css/font-awesome.min.css"><link rel="alternate" type="application/atom+xml" title="ATOM 1.0" href="/atom.xml"><meta name="generator" content="Hexo 7.1.1"></head><body><div class="sidebar animated fadeInDown"><div class="logo-title"><div class="title"><img src="/images/ning.jpg" style="width:200px;"><h3 title=""><a href="/">NingLab</a></h3></div></div><ul class="social-links"><li><a target="_blank" rel="noopener" href="https://twitter.com/ningchang_"><i class="fa fa-twitter"></i></a></li><li><a target="_blank" rel="noopener" href="https://github.com/cacachang"><i class="fa fa-github"></i></a></li><li><a href="mailto:a24701770@gmail.com"><i class="fa fa-envelope"></i></a></li><li><a target="_blank" rel="noopener" href="https://www.instagram.com/web543_/"><i class="fa fa-instagram"></i></a></li><li><a target="_blank" rel="noopener" href="https://www.linkedin.com/in/%E7%8F%88%E5%AF%A7-%E5%BC%B5-140a86125/"><i class="fa fa-linkedin"></i></a></li></ul><div class="footer"><div class="by_farbox"><a href="https://hexo.io/zh-cn/" target="_blank">Proudly published with Hexo&#65281;</a></div></div></div><div class="main"><div class="page-top animated fadeInDown"><div class="nav"><li><a href="/">首頁</a></li><li><a href="/archives">文章</a></li><li><a href="/categories">目錄</a></li><li><a href="/about">關於 Ning</a></li></div><div class="information"><div class="back_btn"><li><a class="fa fa-chevron-left" onclick="window.history.go(-1)"> </a></li></div><div class="avatar"><img src="/images/favicon.jpeg"></div></div></div><div class="autopagerize_page_element"><div class="content"><div class="post-page"><div class="post animated fadeInDown"><div class="post-title"><h3><a>SQL - Joins、Includes 差別在哪裡？</a></h3></div><div class="post-content"><h1 id="Join-and-Includes"><a href="#Join-and-Includes" class="headerlink" title="Join and Includes"></a>Join and Includes</h1><p>我們在開發的時候免不了關聯資料庫，在撈資料的時候也常常會需要用到 joins 跟 includes</p>
<h2 id="所以，我們什麼時候會用到-joins-跟-includes"><a href="#所以，我們什麼時候會用到-joins-跟-includes" class="headerlink" title="所以，我們什麼時候會用到 joins 跟 includes"></a>所以，我們什麼時候會用到 joins 跟 includes</h2><ul>
<li>要尋找跟其他 model 有關聯的資料</li>
<li>避免 N + 1 問題</li>
</ul>
<p>** N + 1 問題是什麼呢？<br>當我們查詢多筆資料時，資料庫會先將所有的資料撈出，並一個一個去比對，就會有 N(筆資料) + 1(次撈出全部) 的問題存在</p>
<h2 id="joins-跟-includes-有什麼差別？"><a href="#joins-跟-includes-有什麼差別？" class="headerlink" title="joins 跟 includes 有什麼差別？"></a>joins 跟 includes 有什麼差別？</h2><p><img src="https://i.imgur.com/ZEftaXX.jpg"></p>
<p>joins 跟 includes 其實有蠻大的差別，</p>
<p>不過因為他們都是在查詢關聯資料，所以我們很常搞混，</p>
<p>不過搞懂他們的差別就會知道什麼時候該派誰上場。</p>
<p>** lazy loading：並不會一開始就載入所有資料，而是需要用到的時候才會去收集並載入<br>** eager loading：一開始就把需要的資料都載入，需要時就可以從 Cache 中拿取</p>
<p>先來說結論：joins 只會去比對資料，而 includes 會去查詢有關聯的資料，並存到 cache 中</p>
<p>那我們來看一下實際使用吧</p>
<h3 id="joins"><a href="#joins" class="headerlink" title="joins"></a>joins</h3><p>使用 joins 時，會去「比對」Tag 中有 post_id 的資料</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">find_tags = <span class="title class_">Post</span>.joins(<span class="symbol">:tags</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Post Load (1.0ms)  SELECT &quot;posts&quot;.* FROM &quot;posts&quot; INNER JOIN &quot;tags&quot; ON &quot;tags&quot;.&quot;post_id&quot; = &quot;posts&quot;.&quot;id&quot; </span></span><br></pre></td></tr></table></figure>
<p>當我們需要這包資料時，<br>這時會再去資料庫撈一次資料，把有 tag 的資料撈出來呈現</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">find_tags.each <span class="keyword">do</span> |<span class="params">post</span>|</span><br><span class="line">  p post.tags.first.name</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Tag Load (0.3ms)  SELECT &quot;tags&quot;.* FROM &quot;tags&quot; WHERE &quot;tags&quot;.&quot;post_id&quot; = $1 ORDER BY &quot;tags&quot;.&quot;id&quot; ASC LIMIT $2  [[&quot;post_id&quot;, 4], [&quot;LIMIT&quot;, 1]]</span></span><br><span class="line"><span class="number">1</span> </span><br><span class="line"></span><br><span class="line"><span class="comment"># Tag Load (0.1ms)  SELECT &quot;tags&quot;.* FROM &quot;tags&quot; WHERE &quot;tags&quot;.&quot;post_id&quot; = $1 ORDER BY &quot;tags&quot;.&quot;id&quot; ASC LIMIT $2  [[&quot;post_id&quot;, 7], [&quot;LIMIT&quot;, 1]]                                         </span></span><br><span class="line"><span class="number">2</span> </span><br><span class="line"></span><br><span class="line"><span class="comment"># Tag Load (0.1ms)  SELECT &quot;tags&quot;.* FROM &quot;tags&quot; WHERE &quot;tags&quot;.&quot;post_id&quot; = $1 ORDER BY &quot;tags&quot;.&quot;id&quot; ASC LIMIT $2  [[&quot;post_id&quot;, 8], [&quot;LIMIT&quot;, 1]]                                         </span></span><br><span class="line"><span class="number">3</span> </span><br></pre></td></tr></table></figure>

<p>看起來是不是很沒效率呢？<br>那我們來看看 includes 會怎麼運作</p>
<h3 id="includes"><a href="#includes" class="headerlink" title="includes"></a>includes</h3><p>使用 includes 時，會去把所有 Tag 的資料一次撈出並查詢哪些有 post_id</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">find_tags = <span class="title class_">Post</span>.includes(<span class="symbol">:tags</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Post Load (0.4ms)  SELECT &quot;posts&quot;.* FROM &quot;posts&quot; </span></span><br><span class="line"><span class="comment"># Tag Load (0.3ms)  SELECT &quot;tags&quot;.* FROM &quot;tags&quot; WHERE &quot;tags&quot;.&quot;post_id&quot; IN ($1, $2, $3, $4, $5, $6, $7, $8)  [[&quot;post_id&quot;, 3], [&quot;post_id&quot;, 4], [&quot;post_id&quot;, 7], [&quot;post_id&quot;, 8], [&quot;post_id&quot;, 9], [&quot;post_id&quot;, 2], [&quot;post_id&quot;, 1], [&quot;post_id&quot;, 10]] </span></span><br></pre></td></tr></table></figure>

<p>當我們需要使用這包資料時，<br>會直接從 Cache 中拿出這包已經處理好的資料</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">find_tags.each <span class="keyword">do</span> |<span class="params">post</span>|</span><br><span class="line">  p post.tags.first.name</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="number">1</span></span><br><span class="line"><span class="number">2</span></span><br><span class="line"><span class="number">3</span></span><br></pre></td></tr></table></figure>

<p>由上述例子可以知道， includes 在查詢及撈資料的過程都相對有效率</p>
<h2 id="所以用-includes-就比較好嗎？"><a href="#所以用-includes-就比較好嗎？" class="headerlink" title="所以用 includes 就比較好嗎？"></a>所以用 includes 就比較好嗎？</h2><p>要看使用的狀況，以剛剛的 Post 及 Tag 例子來看</p>
<p>我們改變一下需求，要撈出有 tag 的 post 資料，只需要呈現<strong>特定 tag 的 post 資訊</strong></p>
<h4 id="joins-1"><a href="#joins-1" class="headerlink" title="joins"></a>joins</h4><p>這時候 joins 只有去比對條件，並沒有去撈出資料</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">find_tags = <span class="title class_">Post</span>.joins(<span class="symbol">:tags</span>).where(<span class="symbol">tag:</span> &#123;<span class="symbol">name:</span> <span class="string">&#x27;hello&#x27;</span>&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">#  Post Load (0.5ms)  SELECT &quot;posts&quot;.* FROM &quot;posts&quot; INNER JOIN &quot;tags&quot; ON &quot;tags&quot;.&quot;post_id&quot; = &quot;posts&quot;.&quot;id&quot; WHERE &quot;tags&quot;.&quot;tag_name&quot; = $1  [[&quot;tag_name&quot;, &quot;hello&quot;]]</span></span><br><span class="line"></span><br><span class="line">find_tags.each <span class="keyword">do</span> |<span class="params">post</span>|</span><br><span class="line">  p post.id</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 1</span></span><br></pre></td></tr></table></figure>

<h4 id="includes-1"><a href="#includes-1" class="headerlink" title="includes"></a>includes</h4><p>使用 includes ，會到資料庫將所有有關聯的資料撈出來做一次查詢</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">find_tags = <span class="title class_">Post</span>.includes(<span class="symbol">:tags</span>).where(<span class="symbol">tag:</span> &#123;<span class="symbol">name:</span> <span class="string">&#x27;hello&#x27;</span>&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment"># SQL (1.0ms)  SELECT &quot;posts&quot;.&quot;id&quot; AS t0_r0, &quot;posts&quot;.&quot;title&quot; AS t0_r1, &quot;posts&quot;.&quot;description&quot; AS t0_r2, &quot;posts&quot;.&quot;content&quot; AS t0_r3, &quot;posts&quot;.&quot;created_at&quot; AS t0_r4, &quot;posts&quot;.&quot;updated_at&quot; AS t0_r5, &quot;posts&quot;.&quot;slug&quot; AS t0_r6, &quot;tags&quot;.&quot;id&quot; AS t1_r0, &quot;tags&quot;.&quot;tag_id&quot; AS t1_r1, &quot;tags&quot;.&quot;post_id&quot; AS t1_r2, &quot;tags&quot;.&quot;created_at&quot; AS t1_r3, &quot;tags&quot;.&quot;updated_at&quot; AS t1_r4 FROM &quot;posts&quot; LEFT OUTER JOIN &quot;tags&quot; ON &quot;tags&quot;.&quot;post_id&quot; = &quot;posts&quot;.&quot;id&quot; WHERE &quot;tags&quot;.&quot;tag_name&quot; = $1  [[&quot;tag_name&quot;, &quot;hello&quot;]] </span></span><br><span class="line"></span><br><span class="line">find_tags.each <span class="keyword">do</span> |<span class="params">post</span>|</span><br><span class="line">  p post.tags.first.name</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 1</span></span><br></pre></td></tr></table></figure>

<p>在不需要印出關聯資料庫的資料狀況時， joins 只有去比對資料，並沒有撈資料的動作，所以會比 includes 更有效率。</p>
<h2 id="結論"><a href="#結論" class="headerlink" title="結論"></a>結論</h2><p>在查詢關聯資料時，joins 只會去比對資料，而 includes 則會去查詢有關聯的資料並存到 Cache 中。在實際使用中，joins 會比 includes 更加高效，特別是當我們不需要印出關聯資料時。</p>
</div><div class="post-footer"><div class="meta"><div class="info"><i class="fa fa-sun-o"></i><span class="date">2023-04-08</span><i class="fa fa-tag"></i><a class="tag" href="/categories/資料庫/" title="資料庫">資料庫 </a></div></div></div></div><div class="share"><div class="evernote"><a class="fa fa-bookmark" href="javascript:(function(){EN_CLIP_HOST='http://www.evernote.com';try{var%20x=document.createElement('SCRIPT');x.type='text/javascript';x.src=EN_CLIP_HOST+'/public/bookmarkClipper.js?'+(new%20Date().getTime()/100000);document.getElementsByTagName('head')[0].appendChild(x);}catch(e){location.href=EN_CLIP_HOST+'/clip.action?url='+encodeURIComponent(location.href)+'&amp;title='+encodeURIComponent(document.title);}})();" ref="nofollow" target="_blank"></a></div><div class="twitter"><a class="fa fa-twitter" target="_blank" rel="noopener" href="http://twitter.com/home?status=,http://ninglab.com/SQL-Joins、Includes-差別在哪裡？/,NingLab,SQL - Joins、Includes 差別在哪裡？,;"></a></div></div><div><script type="text/javascript">document.write("<iframe scrolling='no' frameborder='0' sandbox='allow-scripts allow-same-origin allow-popups allow-popups-to-escape-sandbox allow-storage-access-by-user-activation' style='height: 212px; width: 100%;' src='https://button.like.co/in/embed/a24701770/button?referrer=" + encodeURIComponent(location.href.split("?")[0].split("#")[0]) + "'></iframe>");</script></div><div class="pagination"><ul class="clearfix"><li class="pre pagbuttons"><a class="btn" role="navigation" href="/SQL-%E4%B8%8D%E7%AE%A1%E6%98%AF%E4%BA%A4%E9%9B%86%E9%82%84%E6%98%AF%E8%81%AF%E9%9B%86%EF%BC%8CJOIN-%E9%83%BD%E8%83%BD%E6%89%BE%E5%88%B0/" title="SQL - 不管是交集還是聯集，JOIN 都能找到">上一篇</a></li><li class="next pagbuttons"><a class="btn" role="navigation" href="/Docker-Dockerfile-%E5%9F%BA%E6%9C%AC%E4%BB%8B%E7%B4%B9%E5%8F%8A%E6%8C%87%E4%BB%A4/" title="Docker - Dockerfile 基本介紹及指令">下一篇</a></li></ul></div></div></div></div></div><script src="/js/jquery.js"></script><script src="/js/jquery-migrate-1.2.1.min.js"></script><script src="/js/jquery.appear.js"></script></body></html>