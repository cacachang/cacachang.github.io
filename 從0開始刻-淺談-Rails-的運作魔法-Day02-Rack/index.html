<!DOCTYPE html><html lang="zh-TW"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><meta name="author"><title>從0開始刻 淺談 Rails 的運作魔法 Day02 - Rack · NingLab</title><meta name="description" content="Rack是什麼？Rack 就像 Ruby 與 Web Browser 之間的溝通橋樑使用簡單的方法來傳遞 HTTP requestHTTP 收到 request 後會傳回應給我們
Rack 有固定的規格，它需要有個可以回應 call 方法的物件
以下 Ruby 程式碼來說call 的參數是一個 ha"><meta name="keywords"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><script async src="https://www.googletagmanager.com/gtag/js?id=G-4P2R013PGL"></script><script>window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'G-4P2R013PGL')
</script><meta name="renderer" content="webkit"><link rel="short icon" href="/images/favicon.jpeg" type="image/x-icon"><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="/css/blog_basic.css"><link rel="stylesheet" href="/css/font-awesome.min.css"><link rel="alternate" type="application/atom+xml" title="ATOM 1.0" href="/atom.xml"><meta name="generator" content="Hexo 7.1.1"></head><body><div class="sidebar animated fadeInDown"><div class="logo-title"><div class="title"><img src="/images/ning.jpg" style="width:200px;"><h3 title=""><a href="/">NingLab</a></h3></div></div><ul class="social-links"><li><a target="_blank" rel="noopener" href="https://twitter.com/ningchang_"><i class="fa fa-twitter"></i></a></li><li><a target="_blank" rel="noopener" href="https://github.com/cacachang"><i class="fa fa-github"></i></a></li><li><a href="mailto:a24701770@gmail.com"><i class="fa fa-envelope"></i></a></li><li><a target="_blank" rel="noopener" href="https://www.instagram.com/web543_/"><i class="fa fa-instagram"></i></a></li><li><a target="_blank" rel="noopener" href="https://www.linkedin.com/in/cacachang/"><i class="fa fa-linkedin"></i></a></li><li><a target="_blank" rel="noopener" href="https://www.youtube.com/channel/UCwRiNPzYITZWaif23HTmHZQ"><i class="fa fa-youtube"></i></a></li></ul><div class="footer"><div class="by_farbox"><a href="https://hexo.io/zh-cn/" target="_blank">Proudly published with Hexo&#65281;</a></div></div></div><div class="main"><div class="page-top animated fadeInDown"><div class="nav"><li><a href="/">首頁</a></li><li><a href="/archives">文章</a></li><li><a href="/categories">目錄</a></li><li><a href="/about">關於 Ning</a></li></div><div class="information"><div class="back_btn"><li><a class="fa fa-chevron-left" onclick="window.history.go(-1)"> </a></li></div><div class="avatar"><img src="/images/favicon.jpeg"></div></div></div><div class="autopagerize_page_element"><div class="content"><div class="post-page"><div class="post animated fadeInDown"><div class="post-title"><h3><a>從0開始刻 淺談 Rails 的運作魔法 Day02 - Rack</a></h3></div><div class="post-content"><h2 id="Rack是什麼？"><a href="#Rack是什麼？" class="headerlink" title="Rack是什麼？"></a>Rack是什麼？</h2><p>Rack 就像 Ruby 與 Web Browser 之間的溝通橋樑<br>使用簡單的方法來傳遞 HTTP request<br>HTTP 收到 request 後會傳回應給我們</p>
<p>Rack 有固定的規格，它需要有個可以回應 call 方法的物件</p>
<p>以下 Ruby 程式碼來說<br>call 的參數是一個 hash<br>這個 hash 包含了 CGI-like 環境的變數<br>回傳為陣列，分別為 HTTP 狀態、HTTP header、Body</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Application</span></span><br><span class="line">  <span class="keyword">def</span> <span class="title function_">call</span>(<span class="params">env</span>)</span><br><span class="line">      [</span><br><span class="line">        <span class="number">200</span>, </span><br><span class="line">        &#123;<span class="string">&#x27;Content-Type&#x27;</span> =&gt; <span class="string">&#x27;text/html&#x27;</span>&#125;,</span><br><span class="line">        [<span class="string">&quot;Hello from Ruby on Rulers!&quot;</span>]</span><br><span class="line">      ]</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">run <span class="title class_">Application</span>.new</span><br></pre></td></tr></table></figure>

<p>當我們跑 Rack 時，會啟用一個叫做 WEBrick 的伺服器<br>看到下列訊息就可以進入 <a target="_blank" rel="noopener" href="http://localhost:9292/">http://localhost:9292/</a> 伺服器囉！<br>(之後手刻也會看到它)</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[2022-08-16 02:08:12] INFO  WEBrick 1.6.0</span><br><span class="line">[2022-08-16 02:08:12] INFO  ruby 2.7.2 (2020-10-01) [arm64-darwin20]</span><br><span class="line">[2022-08-16 02:08:12] INFO  WEBrick::HTTPServer#start: pid=45085 port=9292</span><br></pre></td></tr></table></figure>

<p>看看流程圖加速理解👇</p>
<p><img src="https://i.imgur.com/ZyYTeDl.jpg"></p>
</br>

<p>📃 web 小辭典</p>
<p>▶  CGI: 是一種標準介面程式，讓網頁跟 www server 溝通，讓使用者能跟網頁互動</p>
<p>▶  WEBrick：屬於 Ruby library，提供簡單的 HTTP server</p>
</br>


<h2 id="Rack-在-Rails-中的角色"><a href="#Rack-在-Rails-中的角色" class="headerlink" title="Rack 在 Rails 中的角色"></a>Rack 在 Rails 中的角色</h2><p>Rack 是一種 Middleware，是框架與伺服器之間的 API<br>Rails.application 是屬於 Rack 應用程式物件<br>與 Rack 相容的 web server 都應該要採用 Rails.application 來運作、執行</p>
<h3 id="rails-server"><a href="#rails-server" class="headerlink" title="rails server"></a>rails server</h3><p>Rails::Server 繼承 Rack::Server特性<br>可以用來啟動 web server</p>
<p>當我們輸入 rails server 時<br>會建立 Rack::Server 物件<br>並且開啟 server</p>
<h3 id="rackup"><a href="#rackup" class="headerlink" title="rackup"></a>rackup</h3><p>如果不想用 rails server 啟動伺服器<br>可改用 rackup<br>不過你得先有 config.ru 的設定檔(.ru 就是 rackup 的縮寫)</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">開啟 server</span></span><br><span class="line">rackup config.ru </span><br></pre></td></tr></table></figure>

<h4 id="Rack-並不是只拿來啟動伺服器"><a href="#Rack-並不是只拿來啟動伺服器" class="headerlink" title="Rack 並不是只拿來啟動伺服器"></a>Rack 並不是只拿來啟動伺服器</h4><p>Rack 這麼厲害，怎麼可能只會啟動伺服器<br>Rails 中許多應用程式都是使用 Rack Middleware 來操作</p>
<p>不過這些應用程式運作的對象也都跟瀏覽器脫離不了關係</p>
<p>這邊來提幾個應用程式</p>
<p>Rack::Sendfile 👉 用標準化的資料格式(<a target="_blank" rel="noopener" href="https://www.nginx.com/resources/wiki/start/topics/examples/xsendfile/">X-Sendfile</a>)設定 Header</p>
<p>Rack::Lock 👉 設定應用程式是否可以多工作業(<a target="_blank" rel="noopener" href="https://zh.wikipedia.org/zh-tw/%E4%BA%92%E6%96%A5%E9%94%81">Mutex</a>)</p>
<p>Rack::MethodOverride 👉 有設定 params[:_method]，就可以重新設定方法</p>
<p>其他應用程式詳細資料可以參照 <a target="_blank" rel="noopener" href="https://guides.rubyonrails.org/rails_on_rack.html">Rails 官方網站</a></p>
<h2 id="Rack-Middleware-運作"><a href="#Rack-Middleware-運作" class="headerlink" title="Rack Middleware 運作"></a>Rack Middleware 運作</h2><p>採用 pipeline 方式(管線化)<br>用這種方式運作會讓效率大幅提升<br>讓我們來看一下他的運作流程</p>
<p><img src="https://i.imgur.com/LbGVuOM.jpg"></p>
<p>Rack 會依照不同類型請求來區分<br>執行順序1：認證的讀取指令開始執行<br>執行順序2：認證的指令解碼及讀取暫存、授權的讀取指令會一起進行<br>⋯⋯依此類推</p>
<p>📌 生活小例子</p>
<p>以選舉流程來說<br>當A開始進入投票流程時，其他人的個別進度也可以同時被推進<br>減少等待時間、提升效率</p>
<p><img src="https://i.imgur.com/2NCyqsQ.jpg"></p>
<h2 id="Rake、Rack-傻傻分不清"><a href="#Rake、Rack-傻傻分不清" class="headerlink" title="Rake、Rack 傻傻分不清"></a>Rake、Rack 傻傻分不清</h2><p>他們簡直就是雙胞胎<br>稍一不留神就認錯了啊</p>
<p>Rack 是一種 Middleware，主要負責處理跟 HTTP request 有關的任務<br>Rake 是 Rails 中的 task 執行者，讀取 Rakefile 會開始執行 task</p>
<p>遇到這兩兄弟要記得拿放大鏡看清楚🧐<br>今天就先介紹到這邊哩 😉</p>
</div><div class="post-footer"><div class="meta"><div class="info"><i class="fa fa-sun-o"></i><span class="date">2022-08-16</span><i class="fa fa-tag"></i><a class="tag" href="/categories/Rebuild-Rails/" title="Rebuild Rails">Rebuild Rails </a></div></div></div></div><div class="share"><div class="evernote"><a class="fa fa-bookmark" href="javascript:(function(){EN_CLIP_HOST='http://www.evernote.com';try{var%20x=document.createElement('SCRIPT');x.type='text/javascript';x.src=EN_CLIP_HOST+'/public/bookmarkClipper.js?'+(new%20Date().getTime()/100000);document.getElementsByTagName('head')[0].appendChild(x);}catch(e){location.href=EN_CLIP_HOST+'/clip.action?url='+encodeURIComponent(location.href)+'&amp;title='+encodeURIComponent(document.title);}})();" ref="nofollow" target="_blank"></a></div><div class="twitter"><a class="fa fa-twitter" target="_blank" rel="noopener" href="http://twitter.com/home?status=,http://ninglab.com/從0開始刻-淺談-Rails-的運作魔法-Day02-Rack/,NingLab,從0開始刻 淺談 Rails 的運作魔法 Day02 - Rack,;"></a></div></div><div><script src="https://utteranc.es/client.js" repo="cacachang/cacachang.github.io" issue-term="title" theme="github-light" crossorigin="anonymous" async></script></div><div><script type="text/javascript">document.write("<iframe scrolling='no' frameborder='0' sandbox='allow-scripts allow-same-origin allow-popups allow-popups-to-escape-sandbox allow-storage-access-by-user-activation' style='height: 212px; width: 100%;' src='https://button.like.co/in/embed/a24701770/button?referrer=" + encodeURIComponent(location.href.split("?")[0].split("#")[0]) + "'></iframe>");</script></div><div class="pagination"><ul class="clearfix"><li class="pre pagbuttons"><a class="btn" role="navigation" href="/%E5%BE%9E0%E9%96%8B%E5%A7%8B%E5%88%BB-%E6%B7%BA%E8%AB%87-Rails-%E7%9A%84%E9%81%8B%E4%BD%9C%E9%AD%94%E6%B3%95-Day03-GEM/" title="從0開始刻 淺談 Rails 的運作魔法 - Day03 GEM">上一篇</a></li><li class="next pagbuttons"><a class="btn" role="navigation" href="/%E5%BE%9E0%E9%96%8B%E5%A7%8B%E5%88%BB-%E6%B7%BA%E8%AB%87-Rails-%E7%9A%84%E9%81%8B%E4%BD%9C%E9%AD%94%E6%B3%95-Day01-RMVC%E6%9E%B6%E6%A7%8B%E4%B9%8B%E7%82%BA%E4%BB%80%E9%BA%BC%E8%A6%81%E5%AE%89%E8%A3%9Dnode-js/" title="從0開始刻 淺談 Rails 的運作魔法 Day01 RMVC架構之為什麼要安裝node.js">下一篇</a></li></ul></div></div></div></div></div><script src="/js/jquery.js"></script><script src="/js/jquery-migrate-1.2.1.min.js"></script><script src="/js/jquery.appear.js"></script></body></html>