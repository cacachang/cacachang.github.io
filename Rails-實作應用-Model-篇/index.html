<!DOCTYPE html><html lang="zh-TW"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><meta name="author"><title>Rails 實作應用 - Model 篇 · NingLab</title><meta name="description" content="Model我們會把這些東西放在Model

商業邏輯方法
資料驗證(寫入資料庫前)
資料表關聯

商業邏輯方法簡短方法可用 scope 來寫*小提醒：where 都放在 Model 寫，不要放 Controller
1scope :available, -&amp;gt; &amp;#123; where(dele"><meta name="keywords"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="renderer" content="webkit"><link rel="short icon" href="/images/favicon.jpeg" type="image/x-icon"><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="/css/blog_basic.css"><link rel="stylesheet" href="/css/font-awesome.min.css"><link rel="alternate" type="application/atom+xml" title="ATOM 1.0" href="/atom.xml"><meta name="generator" content="Hexo 7.1.1"></head><body><div class="sidebar animated fadeInDown"><div class="logo-title"><div class="title"><img src="/images/ning.jpg" style="width:200px;"><h3 title=""><a href="/">NingLab</a></h3></div></div><ul class="social-links"><li><a target="_blank" rel="noopener" href="https://twitter.com/ningchang_"><i class="fa fa-twitter"></i></a></li><li><a target="_blank" rel="noopener" href="https://github.com/cacachang"><i class="fa fa-github"></i></a></li><li><a href="mailto:a24701770@gmail.com"><i class="fa fa-envelope"></i></a></li><li><a target="_blank" rel="noopener" href="https://www.instagram.com/web543_/"><i class="fa fa-instagram"></i></a></li><li><a target="_blank" rel="noopener" href="https://www.linkedin.com/in/%E7%8F%88%E5%AF%A7-%E5%BC%B5-140a86125/"><i class="fa fa-linkedin"></i></a></li></ul><div class="footer"><div class="by_farbox"><a href="https://hexo.io/zh-cn/" target="_blank">Proudly published with Hexo&#65281;</a></div></div></div><div class="main"><div class="page-top animated fadeInDown"><div class="nav"><li><a href="/">首頁</a></li><li><a href="/archives">文章</a></li><li><a href="/categories">目錄</a></li><li><a href="/about">關於 Ning</a></li></div><div class="information"><div class="back_btn"><li><a class="fa fa-chevron-left" onclick="window.history.go(-1)"> </a></li></div><div class="avatar"><img src="/images/favicon.jpeg"></div></div></div><div class="autopagerize_page_element"><div class="content"><div class="post-page"><div class="post animated fadeInDown"><div class="post-title"><h3><a>Rails 實作應用 - Model 篇</a></h3></div><div class="post-content"><h2 id="Model"><a href="#Model" class="headerlink" title="Model"></a>Model</h2><p>我們會把這些東西放在Model</p>
<ol>
<li>商業邏輯方法</li>
<li>資料驗證(寫入資料庫前)</li>
<li>資料表關聯</li>
</ol>
<h3 id="商業邏輯方法"><a href="#商業邏輯方法" class="headerlink" title="商業邏輯方法"></a>商業邏輯方法</h3><p>簡短方法可用 scope 來寫<br>*小提醒：where 都放在 Model 寫，不要放 Controller</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">scope <span class="symbol">:available</span>, -&gt; &#123; where(<span class="symbol">deleted_at:</span> <span class="literal">nil</span>) &#125;</span><br></pre></td></tr></table></figure>
<p>預設方法：default_scope (設定就會套用在所有的搜尋中)</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">default_scope &#123; where(<span class="symbol">deleted_at:</span> <span class="literal">nil</span>) &#125;</span><br></pre></td></tr></table></figure>
<p>解除預設方法：unscope(:where)</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">scope <span class="symbol">:available</span>, -&gt; &#123; unscope(<span class="symbol">:where</span>).where(<span class="symbol">deleted_at:</span> <span class="literal">nil</span>) &#125;</span><br></pre></td></tr></table></figure>

<h3 id="資料驗證"><a href="#資料驗證" class="headerlink" title="資料驗證"></a>資料驗證</h3><p>針對寫入的資料做驗證，不符合就無法存入資料庫中</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">validates <span class="symbol">:title</span>, <span class="symbol">presence:</span> <span class="literal">true</span>, </span><br><span class="line">                  <span class="symbol">length:</span> &#123; <span class="symbol">minimum:</span> <span class="number">2</span> &#125;</span><br></pre></td></tr></table></figure>

<h3 id="資料表關聯"><a href="#資料表關聯" class="headerlink" title="資料表關聯"></a>資料表關聯</h3><p>讓 table 與 table 之間產生方法來互相存取，並非真的有關聯</p>
<h4 id="一對一"><a href="#一對一" class="headerlink" title="一對一"></a>一對一</h4><figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># user.rb</span></span><br><span class="line"><span class="comment"># 一個 user 可以擁有一個 blog</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">User</span> &lt; <span class="title class_ inherited__">ApplicationRecord</span></span><br><span class="line">  has_one <span class="symbol">:blog</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># blog.rb</span></span><br><span class="line"><span class="comment"># blog 屬於 user</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Blog</span> &lt; <span class="title class_ inherited__">ApplicationRecord</span></span><br><span class="line">  belongs_to <span class="symbol">:user</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<h4 id="一對多"><a href="#一對多" class="headerlink" title="一對多"></a>一對多</h4><figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># user.rb</span></span><br><span class="line"><span class="comment"># 一個 user 可以擁有很多 article </span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">User</span> &lt; <span class="title class_ inherited__">ApplicationRecord</span></span><br><span class="line">  has_many <span class="symbol">:articles</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># article.rb</span></span><br><span class="line"><span class="comment"># article 屬於 user</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Article</span> &lt; <span class="title class_ inherited__">ApplicationRecord</span></span><br><span class="line">  belongs_to <span class="symbol">:user</span>  </span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<h4 id="多對多"><a href="#多對多" class="headerlink" title="多對多"></a>多對多</h4><ul>
<li>如果 has_many 的 table 與 has_one 的 table 重複，要使用 source 來指定foreign key</li>
</ul>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># user.rb</span></span><br><span class="line"><span class="comment"># user 可以喜歡很多篇 articles</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">User</span> &lt; <span class="title class_ inherited__">ApplicationRecord</span></span><br><span class="line">  has_many <span class="symbol">:like_articles</span></span><br><span class="line">  has_many <span class="symbol">:liked_articles</span>, <span class="symbol">through:</span> <span class="symbol">:like_articles</span>, <span class="symbol">source:</span> <span class="symbol">:article</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># article.rb</span></span><br><span class="line"><span class="comment"># article 可以被很多個 user 喜歡</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Article</span> &lt; <span class="title class_ inherited__">ApplicationRecord</span></span><br><span class="line">  has_many <span class="symbol">:like_articles</span></span><br><span class="line">  has_many <span class="symbol">:users</span>, <span class="symbol">through:</span> <span class="symbol">:like_articles</span>          </span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># like_article.rb</span></span><br><span class="line"><span class="comment"># 透過第三方 table 來存取兩個 table 的資料</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">LikeArticle</span> &lt; <span class="title class_ inherited__">ApplicationRecord</span></span><br><span class="line">  belongs_to <span class="symbol">:user</span></span><br><span class="line">  belongs_to <span class="symbol">:article</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<h4 id="一旦定義了關聯，就會產出相關方法"><a href="#一旦定義了關聯，就會產出相關方法" class="headerlink" title="一旦定義了關聯，就會產出相關方法"></a>一旦定義了關聯，就會產出相關方法</h4><p>以上述 user 來舉例</p>
<p>設定 has_many、has_one，會得到四個方法<br>而 belong_to，只會有上面兩個方法( articles、article&#x3D; )</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">增加 article 跟 article= 方法</span></span><br><span class="line"><span class="meta prompt_">&gt; </span><span class="language-bash">u1.articles</span></span><br><span class="line">  Article Load (0.5ms)  SELECT &quot;articles&quot;.* FROM &quot;articles&quot; WHERE &quot;articles&quot;.&quot;deleted_at&quot; IS NULL AND &quot;articles&quot;.&quot;user_id&quot; = ? /* loading for inspect */ LIMIT ?  [[&quot;user_id&quot;, 1], [&quot;LIMIT&quot;, 11]]</span><br><span class="line"><span class="meta prompt_">  </span></span><br><span class="line"><span class="meta prompt_">&gt; </span><span class="language-bash">u1.articles = [t1]</span></span><br><span class="line">  Article Load (0.3ms)  SELECT &quot;articles&quot;.* FROM &quot;articles&quot; WHERE &quot;articles&quot;.&quot;deleted_at&quot; IS NULL AND &quot;articles&quot;.&quot;user_id&quot; = ?  [[&quot;user_id&quot;, 1]]</span><br><span class="line">  TRANSACTION (0.1ms)  begin transaction</span><br><span class="line">  Article Update (0.7ms)  UPDATE &quot;articles&quot; SET &quot;updated_at&quot; = ?, &quot;user_id&quot; = ? WHERE &quot;articles&quot;.&quot;id&quot; = ?  [[&quot;updated_at&quot;, &quot;2022-08-20 17:05:13.955092&quot;], [&quot;user_id&quot;, 1], [&quot;id&quot;, 1]]</span><br><span class="line">  TRANSACTION (1.0ms)  commit transaction</span><br><span class="line"><span class="meta prompt_">  </span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">增加 build_blog 跟 create_blog 方法</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">&gt; </span><span class="language-bash">u2.create_blog(title: <span class="string">&quot;hey&quot;</span>)</span></span><br><span class="line">  TRANSACTION (0.1ms)  begin transaction</span><br><span class="line">  Blog Create (0.8ms)  INSERT INTO &quot;blogs&quot; (&quot;title&quot;, &quot;user_id&quot;, &quot;created_at&quot;, &quot;updated_at&quot;) VALUES (?, ?, ?, ?)  [[&quot;title&quot;, &quot;hey&quot;], [&quot;user_id&quot;, 9], [&quot;created_at&quot;, &quot;2022-08-20 19:50:55.440307&quot;], [&quot;updated_at&quot;, &quot;2022-08-20 19:50:55.440307&quot;]]</span><br><span class="line">  TRANSACTION (0.5ms)  commit transaction</span><br><span class="line">  Blog Load (0.1ms)  SELECT &quot;blogs&quot;.* FROM &quot;blogs&quot; WHERE &quot;blogs&quot;.&quot;deleted_at&quot; IS NULL AND &quot;blogs&quot;.&quot;user_id&quot; = ? LIMIT ?  [[&quot;user_id&quot;, 9], [&quot;LIMIT&quot;, 1]]</span><br><span class="line"><span class="meta prompt_">  </span></span><br><span class="line"><span class="meta prompt_">&gt; </span><span class="language-bash">u3.create_blog(title:<span class="string">&#x27;yo&#x27;</span>)</span></span><br><span class="line">  TRANSACTION (0.1ms)  begin transaction</span><br><span class="line">  Blog Create (0.7ms)  INSERT INTO &quot;blogs&quot; (&quot;title&quot;, &quot;user_id&quot;, &quot;created_at&quot;, &quot;updated_at&quot;) VALUES (?, ?, ?, ?)  [[&quot;title&quot;, &quot;yo&quot;], [&quot;user_id&quot;, 10], [&quot;created_at&quot;, &quot;2022-08-20 19:52:20.563980&quot;], [&quot;updated_at&quot;, &quot;2022-08-20 19:52:20.563980&quot;]]</span><br><span class="line">  TRANSACTION (0.9ms)  commit transaction</span><br><span class="line">  Blog Load (0.1ms)  SELECT &quot;blogs&quot;.* FROM &quot;blogs&quot; WHERE &quot;blogs&quot;.&quot;deleted_at&quot; IS NULL AND &quot;blogs&quot;.&quot;user_id&quot; = ? LIMIT ?  [[&quot;user_id&quot;, 10], [&quot;LIMIT&quot;, 1]]</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h4 id="table欄位-增加、修改、刪除"><a href="#table欄位-增加、修改、刪除" class="headerlink" title="table欄位 增加、修改、刪除"></a>table欄位 增加、修改、刪除</h4><p>專案做到後面一定會有欄位增減的問題<br>這時候 migration 就很好用</p>
<ul>
<li>記得確認完欄位，要做 <code>rails db:migrate</code></li>
</ul>
<p>相關設定可以參考<a target="_blank" rel="noopener" href="https://guides.rubyonrails.org/active_record_migrations.html">官方網站</a></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">終端機指令</span></span><br><span class="line"><span class="meta prompt_">&gt; </span><span class="language-bash">rails g migration Add_Delted_At_To_Article</span></span><br></pre></td></tr></table></figure>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># db/migrate/xxxxxxx_add_delted_at_to_article</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">AddDeltedAtToArticle</span> &lt; <span class="title class_ inherited__">ActiveRecord::Migration</span>[<span class="number">6.1</span>]</span><br><span class="line">  <span class="keyword">def</span> <span class="title function_">change</span></span><br><span class="line">    <span class="comment"># 增加欄位</span></span><br><span class="line">    add_column <span class="symbol">:articles</span>, <span class="symbol">:deleted_at</span>, <span class="symbol">:datetime</span></span><br><span class="line">    add_index <span class="symbol">:articles</span>, <span class="symbol">:deleted_at</span></span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<h5 id="小補充：index"><a href="#小補充：index" class="headerlink" title="小補充：index"></a>小補充：index</h5><p>使用 index 可以增加效率，但因為多了檢索欄位，會多佔一些空間</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">建立 model 時可以這樣設定</span></span><br><span class="line"><span class="meta prompt_">&gt; </span><span class="language-bash">rails g model Article title content deleted_at:datetime:index</span></span><br></pre></td></tr></table></figure>


<h4 id="密碼加密"><a href="#密碼加密" class="headerlink" title="密碼加密"></a>密碼加密</h4><p>密碼相對其他資料機密且重要，所以我們會對密碼做雙重加密的動作</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">encrypt_password</span></span><br><span class="line">  <span class="comment"># step1 導入 digest 模組</span></span><br><span class="line">  <span class="keyword">require</span> <span class="string">&#x27;digest&#x27;</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># step2 加鹽 salting (讓密碼更複雜，難以被破解)</span></span><br><span class="line">  <span class="comment"># 加上 self 是指 user(class) 的 password</span></span><br><span class="line">  pw = <span class="string">&quot;xx-<span class="subst">#&#123;<span class="variable language_">self</span>.password&#125;</span>-yy&quot;</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># step3 加密</span></span><br><span class="line">  <span class="variable language_">self</span>.password = <span class="title class_">Digest</span><span class="symbol">:</span><span class="symbol">:SHA1</span>.hexdigest(pw)</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure></div><div class="post-footer"><div class="meta"><div class="info"><i class="fa fa-sun-o"></i><span class="date">2022-08-21</span><i class="fa fa-tag"></i><a class="tag" href="/categories/Rails/" title="Rails">Rails </a></div></div></div></div><div class="share"><div class="evernote"><a class="fa fa-bookmark" href="javascript:(function(){EN_CLIP_HOST='http://www.evernote.com';try{var%20x=document.createElement('SCRIPT');x.type='text/javascript';x.src=EN_CLIP_HOST+'/public/bookmarkClipper.js?'+(new%20Date().getTime()/100000);document.getElementsByTagName('head')[0].appendChild(x);}catch(e){location.href=EN_CLIP_HOST+'/clip.action?url='+encodeURIComponent(location.href)+'&amp;title='+encodeURIComponent(document.title);}})();" ref="nofollow" target="_blank"></a></div><div class="twitter"><a class="fa fa-twitter" target="_blank" rel="noopener" href="http://twitter.com/home?status=,http://ninglab.com/Rails-實作應用-Model-篇/,NingLab,Rails 實作應用 - Model 篇,;"></a></div></div><div><script src="https://utteranc.es/client.js" repo="cacachang/cacachang.github.io" issue-term="title" theme="github-light" crossorigin="anonymous" async></script></div><div><script type="text/javascript">document.write("<iframe scrolling='no' frameborder='0' sandbox='allow-scripts allow-same-origin allow-popups allow-popups-to-escape-sandbox allow-storage-access-by-user-activation' style='height: 212px; width: 100%;' src='https://button.like.co/in/embed/a24701770/button?referrer=" + encodeURIComponent(location.href.split("?")[0].split("#")[0]) + "'></iframe>");</script></div><div class="pagination"><ul class="clearfix"><li class="pre pagbuttons"><a class="btn" role="navigation" href="/%E5%BE%9E0%E9%96%8B%E5%A7%8B%E5%88%BB-%E6%B7%BA%E8%AB%87-Rails-%E7%9A%84%E9%81%8B%E4%BD%9C%E9%AD%94%E6%B3%95-Day-06-%E5%AE%8C%E6%95%B4%E6%A1%86%E6%9E%B6%E7%9A%84%E5%9F%BA%E6%9C%AC%E5%8A%9F%E8%83%BD/" title="從0開始刻 淺談 Rails 的運作魔法 - Day 06 完整框架的基本功能">上一篇</a></li><li class="next pagbuttons"><a class="btn" role="navigation" href="/Rails-%E5%AF%A6%E4%BD%9C%E6%87%89%E7%94%A8-Controller-%E7%AF%87/" title="Rails 實作應用 - Controller 篇">下一篇</a></li></ul></div></div></div></div></div><script src="/js/jquery.js"></script><script src="/js/jquery-migrate-1.2.1.min.js"></script><script src="/js/jquery.appear.js"></script></body></html>